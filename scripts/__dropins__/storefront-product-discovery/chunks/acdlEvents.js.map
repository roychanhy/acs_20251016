{"version":3,"file":"acdlEvents.js","sources":["/@dropins/storefront-product-discovery/src/utils/acdlEvents.ts"],"sourcesContent":["/********************************************************************\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  Adobe permits you to use, modify, and distribute this\n * file in accordance with the terms of the Adobe license agreement\n * accompanying it.\n *******************************************************************/\n\nimport { ProductSearchResponse } from '@/plp/data/models/api';\nimport {\n  SearchFilter,\n  SearchInput,\n  SearchInputUnit,\n  SearchSort,\n  SearchResults,\n  SearchResultUnit,\n  SearchResultSuggestion,\n  SearchFacetContext,\n  SearchBucket,\n  SearchResultProduct,\n} from '@/plp/data/models/acdl';\n\nconst SEARCH_INPUT_CONTEXT = 'searchInputContext';\nconst SEARCH_RESULTS_CONTEXT = 'searchResultsContext';\nconst PLP_UNIT_ID = 'livesearch-plp';\nconst SEARCH_UNIT_ID = 'livesearch-popover';\n//const SEARCH_CATEGORY_CLICK = 'search-category-click';\nconst SEARCH_PRODUCT_CLICK = 'search-product-click';\nconst SEARCH_REQUEST_SENT = 'search-request-sent';\nconst SEARCH_RESPONSE_RECEIVED = 'search-response-received';\nconst SEARCH_RESULTS_VIEW = 'search-results-view';\nconst CATEGORY_RESULTS_VIEW = 'category-results-view';\nconst CHANNEL_CONTEXT = 'channelContext';\n\nfunction getAdobeDataLayer() {\n  // @ts-ignore\n  window.adobeDataLayer = window.adobeDataLayer || [];\n  // @ts-ignore\n  return window.adobeDataLayer;\n}\n\n// Get a context from ACDL\nfunction getContext<T>(name?: string): T {\n  const adobeDataLayer = getAdobeDataLayer();\n  return adobeDataLayer.getState ? adobeDataLayer.getState(name) : ({} as T);\n}\n\nfunction setContext(name: string, data: any) {\n  const adobeDataLayer = getAdobeDataLayer();\n\n  // Clear existing context\n  adobeDataLayer.push({\n    [name]: null,\n  });\n\n  // Set new context\n  adobeDataLayer.push({\n    [name]: data,\n  });\n}\n\nfunction getChannelContext() {\n  return {\n    _id: \"https://ns.adobe.com/xdm/channels/web\",\n    _type: \"https://ns.adobe.com/xdm/channel-types/web\",\n  };\n}\n\nfunction setChannelContext() {\n  setContext(CHANNEL_CONTEXT, getChannelContext());\n}\n\nfunction pushEvent(event: string, additionalContext?: any) {\n  const adobeDataLayer = getAdobeDataLayer();\n\n  adobeDataLayer.push((acdl: any) => {\n    const state = acdl.getState ? acdl.getState() : {};\n\n    acdl.push({\n      event,\n      eventInfo: {\n        ...state,\n        ...additionalContext,\n      },\n    });\n  });\n}\n\nconst searchRequestSent = (searchUnitId: string) => {\n  setChannelContext();\n  pushEvent(SEARCH_REQUEST_SENT, { searchUnitId });\n};\n\nconst searchResponseReceived = (searchUnitId: string) => {\n  setChannelContext();\n  pushEvent(SEARCH_RESPONSE_RECEIVED, { searchUnitId });\n};\n\nconst categoryResultsView = (searchUnitId: string) => {\n  pushEvent(CATEGORY_RESULTS_VIEW, { searchUnitId });\n};\n\nconst searchResultsView = (searchUnitId: string) => {\n  pushEvent(SEARCH_RESULTS_VIEW, { searchUnitId });\n};\n\nconst searchProductClick = (sku: string, searchUnitId: string) => {\n  pushEvent(SEARCH_PRODUCT_CLICK, { sku, searchUnitId });\n};\n\nconst updateSearchInputCtx = (\n  searchUnitId: string,\n  searchRequestId: string,\n  phrase: string,\n  filters: Array<SearchFilter>,\n  pageSize: number,\n  currentPage: number,\n  sort: Array<SearchSort>,\n): void => {\n  const acdl = getAdobeDataLayer;\n  if (!acdl) {\n    // don't break search if events are broken/not loading\n    return;\n  }\n\n  const searchInputCtx: SearchInput = getContext(SEARCH_INPUT_CONTEXT) || {};\n  if (!searchInputCtx?.units) {\n    searchInputCtx.units = [];\n  }\n\n  // create search input unit\n  const searchInputUnit: SearchInputUnit = {\n    searchUnitId,\n    searchRequestId,\n    queryTypes: ['products', 'suggestions'],\n    phrase,\n    pageSize,\n    currentPage,\n    filter: filters,\n    sort,\n  };\n\n  // find search input unit index\n  const searchInputUnitIndex = searchInputCtx.units.findIndex((unit) => unit.searchUnitId === searchUnitId);\n\n  // update search input unit\n  if (searchInputUnitIndex < 0) {\n    searchInputCtx.units.push(searchInputUnit);\n  } else {\n    searchInputCtx.units[searchInputUnitIndex] = searchInputUnit;\n  }\n\n  setContext(SEARCH_INPUT_CONTEXT, searchInputCtx);\n};\n\nconst updateSearchResultsCtx = (\n  searchUnitId: string,\n  searchRequestId: string,\n  results: ProductSearchResponse['productSearch'],\n): void => {\n  const acdl = getAdobeDataLayer;\n  if (!acdl) {\n    // don't break search if events are broken/not loading\n    return;\n  }\n  const searchResultsCtx: SearchResults = getContext(SEARCH_RESULTS_CONTEXT) || {};\n  if (!searchResultsCtx?.units) {\n    searchResultsCtx.units = [];\n  }\n\n  // find search result unit index\n  const searchResultUnitIndex = searchResultsCtx.units.findIndex((unit) => unit.searchUnitId === searchUnitId);\n\n  // create search result unit\n  const searchResultUnit: SearchResultUnit = {\n    searchUnitId,\n    searchRequestId,\n    products: createProducts(results.items),\n    categories: [],\n    suggestions: createSuggestions(results.suggestions),\n    page: results?.pageInfo?.currentPage || 1,\n    perPage: results?.pageInfo?.pageSize || 20,\n    facets: createFacets(results.facets as SearchFacetContext[]),\n  };\n\n  // update search result unit\n  if (searchResultUnitIndex < 0) {\n    searchResultsCtx.units.push(searchResultUnit);\n  } else {\n    searchResultsCtx.units[searchResultUnitIndex] = searchResultUnit;\n  }\n\n  setContext(SEARCH_RESULTS_CONTEXT, searchResultsCtx);\n};\n\nconst createProducts = (items: ProductSearchResponse['productSearch']['items']): SearchResultProduct[] => {\n  if (!items) {\n    return [];\n  }\n\n  const products: SearchResultProduct[] = items.map((item, index) => ({\n    name: item?.name,\n    sku: item?.sku,\n    url: item?.url ?? '',\n    imageUrl: item?.images[0]?.url ?? '',\n    price: item?.price?.final?.amount?.value ?? item?.priceRange?.minimum?.regular?.amount?.value,\n    rank: index,\n  }));\n\n  return products;\n};\n\nconst createSuggestions = (items: ProductSearchResponse['productSearch']['suggestions']): SearchResultSuggestion[] => {\n  if (!items) {\n    return [];\n  }\n\n  const suggestions: SearchResultSuggestion[] = items.map((suggestion, index) => ({\n    suggestion,\n    rank: index,\n  }));\n\n  return suggestions;\n};\n\nconst createFacets = (items: SearchFacetContext[]): SearchFacetContext[] => {\n  if (!items) {\n    return [];\n  }\n\n  const facets = items.map<SearchFacetContext>((item) => ({\n    attribute: item?.attribute,\n    title: item?.title,\n    type: item?.type || 'PINNED',\n    buckets: item?.buckets.map<SearchBucket>((bucket: any) => bucket),\n  }));\n\n  return facets;\n};\n\nexport {\n  searchRequestSent,\n  searchResponseReceived,\n  categoryResultsView,\n  searchResultsView,\n  searchProductClick,\n  updateSearchInputCtx,\n  updateSearchResultsCtx,\n  PLP_UNIT_ID,\n  SEARCH_UNIT_ID,\n};\n"],"names":["SEARCH_INPUT_CONTEXT","SEARCH_RESULTS_CONTEXT","PLP_UNIT_ID","SEARCH_UNIT_ID","SEARCH_PRODUCT_CLICK","SEARCH_REQUEST_SENT","SEARCH_RESPONSE_RECEIVED","SEARCH_RESULTS_VIEW","CATEGORY_RESULTS_VIEW","CHANNEL_CONTEXT","getAdobeDataLayer","getContext","name","adobeDataLayer","setContext","data","getChannelContext","setChannelContext","pushEvent","event","additionalContext","acdl","state","searchRequestSent","searchUnitId","searchResponseReceived","categoryResultsView","searchResultsView","searchProductClick","sku","updateSearchInputCtx","searchRequestId","phrase","filters","pageSize","currentPage","sort","searchInputCtx","searchInputUnit","searchInputUnitIndex","unit","updateSearchResultsCtx","results","_a","_b","searchResultsCtx","searchResultUnitIndex","searchResultUnit","createProducts","createSuggestions","createFacets","items","item","index","_c","_d","_e","_f","_g","_h","suggestion","bucket"],"mappings":"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"}