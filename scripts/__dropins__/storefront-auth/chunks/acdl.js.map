{"version":3,"file":"acdl.js","sources":["/@dropins/storefront-auth/src/data/transforms/transform-auth.ts","/@dropins/storefront-auth/src/lib/acdl.ts"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { AccountModel, CustomerModel } from '@/auth/data/models';\n\n/**\n * References:\n * https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/signInAEP.ts\n * https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/createAccountAEP.ts\n */\nexport const transformAccount = (data: CustomerModel): AccountModel => {\n  return {\n    firstName: data.firstName,\n    lastName: data.lastName,\n    emailAddress: data?.email || '',\n    accountId: data?.email || '',\n  };\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { transformAccount } from '../data/transforms';\n\nconst ACCOUNT_CONTEXT = 'accountContext';\nconst CHANNEL_CONTEXT = 'channelContext';\n\nenum EventsList {\n  CREATE_ACCOUNT_EVENT = 'create-account',\n  SIGN_IN = 'sign-in',\n  SIGN_OUT = 'sign-out',\n}\n\nconst events = {\n  // Reference - https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/createAccountAEP.ts\n  CREATE_ACCOUNT: EventsList.CREATE_ACCOUNT_EVENT,\n  // Reference - https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/signInAEP.ts\n  SIGN_IN: EventsList.SIGN_IN,\n  // Reference - https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/signOutAEP.ts\n  SIGN_OUT: EventsList.SIGN_OUT,\n};\n\nexport function getAdobeDataLayer() {\n  // @ts-ignore\n  window.adobeDataLayer = window.adobeDataLayer || [];\n  // @ts-ignore\n  return window.adobeDataLayer;\n}\n\n/**\n * Sets a context in the Adobe Client Data Layer (ACDL)\n * Logic based on: https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-sdk/src/Base.ts#L6\n */\nfunction setContext(name: string, data: any) {\n  const adobeDataLayer = getAdobeDataLayer();\n\n  // Clear existing context\n  adobeDataLayer.push({\n    [name]: null,\n  });\n\n  // Set new context\n  adobeDataLayer.push({\n    [name]: data,\n  });\n}\n\n/**\n * Sets channel context for AEP events\n */\nfunction setChannelContext() {\n  const channelData = {\n    _id: 'https://ns.adobe.com/xdm/channels/web',\n    _type: 'https://ns.adobe.com/xdm/channel-types/web',\n  };\n\n  setContext(CHANNEL_CONTEXT, channelData);\n}\n\n/**\n * Pushes an event to the Adobe Client Data Layer (ACDL)\n * Logic based on: https://github.com/adobe/commerce-events/blob/1973d0ce28471ef190fa06dad6359ffa0ab51db6/packages/storefront-events-sdk/src/Base.ts#L34\n */\nfunction pushEvent(event: string, additionalContext?: any) {\n  const adobeDataLayer = getAdobeDataLayer();\n\n  adobeDataLayer.push((acdl: any) => {\n    const state = acdl.getState ? acdl.getState() : {};\n\n    acdl.push({\n      event,\n      eventInfo: {\n        ...state,\n        ...additionalContext,\n      },\n    });\n  });\n}\n\n/**\n * References:\n * https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/createAccountAEP.ts\n * https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/utils/aep/account.ts\n */\nfunction createAccountEvent(eventData: any) {\n  const accountData = transformAccount(eventData);\n\n  setContext(ACCOUNT_CONTEXT, accountData);\n\n  pushEvent(events.CREATE_ACCOUNT);\n}\n\n/**\n * References:\n * https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/signInAEP.ts\n * https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/utils/aep/account.ts\n */\nfunction loginEvent(eventData: any) {\n  const accountData = transformAccount(eventData);\n\n  setContext(ACCOUNT_CONTEXT, accountData);\n\n  pushEvent(events.SIGN_IN);\n}\n\n/**\n * Based on storefront-events-collector - sign out event should not contain accountContext\n * Reference - https://github.com/adobe/commerce-events/blob/main/packages/storefront-events-collector/src/handlers/account/signOutAEP.ts\n */\nfunction logoutEvent() {\n  pushEvent(events.SIGN_OUT);\n}\n\nconst publishEvents = (eventType: string, eventParams: any) => {\n  const storeConfigRaw = sessionStorage.getItem('storeConfig');\n  const storeConfig = storeConfigRaw ? JSON.parse(storeConfigRaw) : {};\n\n  const eventData = { ...storeConfig, ...eventParams };\n\n  setChannelContext();\n\n  switch (eventType) {\n    case EventsList.CREATE_ACCOUNT_EVENT:\n      createAccountEvent(eventData);\n      break;\n\n    case EventsList.SIGN_IN:\n      loginEvent(eventData);\n      break;\n\n    case EventsList.SIGN_OUT:\n      logoutEvent();\n      break;\n\n    default:\n      return null;\n  }\n};\n\nexport { EventsList, publishEvents, pushEvent };\n"],"names":["transformAccount","data","ACCOUNT_CONTEXT","CHANNEL_CONTEXT","EventsList","events","getAdobeDataLayer","setContext","name","adobeDataLayer","setChannelContext","pushEvent","event","additionalContext","acdl","state","createAccountEvent","eventData","accountData","loginEvent","logoutEvent","publishEvents","eventType","eventParams","storeConfigRaw"],"mappings":"AAwBa,MAAAA,EAAoBC,IACxB,CACL,UAAWA,EAAK,UAChB,SAAUA,EAAK,SACf,cAAcA,GAAA,YAAAA,EAAM,QAAS,GAC7B,WAAWA,GAAA,YAAAA,EAAM,QAAS,EAC5B,GCXIC,EAAkB,iBAClBC,EAAkB,iBAEnB,IAAAC,GAAAA,IACHA,EAAA,qBAAuB,iBACvBA,EAAA,QAAU,UACVA,EAAA,SAAW,WAHRA,IAAAA,GAAA,CAAA,CAAA,EAML,MAAMC,EAAS,CAEb,eAAgB,iBAEhB,QAAS,UAET,SAAU,UACZ,EAEO,SAASC,GAAoB,CAE3B,cAAA,eAAiB,OAAO,gBAAkB,CAAC,EAE3C,OAAO,cAChB,CAMA,SAASC,EAAWC,EAAcP,EAAW,CAC3C,MAAMQ,EAAiBH,EAAkB,EAGzCG,EAAe,KAAK,CAClB,CAACD,CAAI,EAAG,IAAA,CACT,EAGDC,EAAe,KAAK,CAClB,CAACD,CAAI,EAAGP,CAAA,CACT,CACH,CAKA,SAASS,GAAoB,CAM3BH,EAAWJ,EALS,CAClB,IAAK,wCACL,MAAO,4CACT,CAEuC,CACzC,CAMA,SAASQ,EAAUC,EAAeC,EAAyB,CAClCP,EAAkB,EAE1B,KAAMQ,GAAc,CACjC,MAAMC,EAAQD,EAAK,SAAWA,EAAK,WAAa,CAAC,EAEjDA,EAAK,KAAK,CACR,MAAAF,EACA,UAAW,CACT,GAAGG,EACH,GAAGF,CAAA,CACL,CACD,CAAA,CACF,CACH,CAOA,SAASG,EAAmBC,EAAgB,CACpC,MAAAC,EAAclB,EAAiBiB,CAAS,EAE9CV,EAAWL,EAAiBgB,CAAW,EAEvCP,EAAUN,EAAO,cAAc,CACjC,CAOA,SAASc,EAAWF,EAAgB,CAC5B,MAAAC,EAAclB,EAAiBiB,CAAS,EAE9CV,EAAWL,EAAiBgB,CAAW,EAEvCP,EAAUN,EAAO,OAAO,CAC1B,CAMA,SAASe,GAAc,CACrBT,EAAUN,EAAO,QAAQ,CAC3B,CAEM,MAAAgB,EAAgB,CAACC,EAAmBC,IAAqB,CACvD,MAAAC,EAAiB,eAAe,QAAQ,aAAa,EAGrDP,EAAY,CAAE,GAFAO,EAAiB,KAAK,MAAMA,CAAc,EAAI,CAAC,EAE/B,GAAGD,CAAY,EAInD,OAFkBb,EAAA,EAEVY,EAAW,CACjB,IAAK,iBACHN,EAAmBC,CAAS,EAC5B,MAEF,IAAK,UACHE,EAAWF,CAAS,EACpB,MAEF,IAAK,WACSG,EAAA,EACZ,MAEF,QACS,OAAA,IAAA,CAEb"}