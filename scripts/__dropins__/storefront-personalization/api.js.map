{"version":3,"file":"api.js","sources":["/@dropins/storefront-personalization/src/api/initialize/initialize.ts","/@dropins/storefront-personalization/src/data/transforms/transform-visitor-data.ts","/@dropins/storefront-personalization/src/api/fetchPersonalizationData/graphql/PersonalizationDataQuery.ts","/@dropins/storefront-personalization/src/api/fetchPersonalizationData/fetchPersonalizationData.ts","/@dropins/storefront-personalization/src/api/savePersonalizationData/savePersonalizationData.ts"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Initializer } from '@adobe-commerce/elsie/lib';\nimport { Lang } from '@adobe-commerce/elsie/i18n';\nimport { events } from '@adobe-commerce/event-bus';\nimport {fetchPersonalizationData, getStoreConfig, savePersonalizationData} from '@/personalization/api';\n\ntype ConfigProps = {\n  langDefinitions?: Lang;\n};\n\nconst REQUIRE_UPDATE_KEY = 'DROPIN__PERSONALIZATION__REQUIRE_UPDATE__DATA';\nconst AUTH_KEY = 'DROPIN__PERSONALIZATION__AUTH';\n\nconst updatePersonalizationData = async (cartId: string) => {\n  const data = await fetchPersonalizationData(cartId);\n  if (data !== null) {\n    savePersonalizationData(data);\n  }\n};\n\nconst isEnabled = async () => {\n  const config = await getStoreConfig();\n  return config?.shareActiveSegments && config.shareCustomerGroup && config.shareAppliedCartRule;\n};\n\nexport const initialize = new Initializer<ConfigProps>({\n  init: async (config) => {\n    const defaultConfig = {};\n\n    initialize.config.setConfig({ ...defaultConfig, ...config });\n  },\n\n  listeners: () => [\n    events.on('authenticated', async (authenticated) => {\n      const enabled = await isEnabled();\n      if (!enabled) {\n        return;\n      }\n      const storedAuth = sessionStorage.getItem(AUTH_KEY);\n      if (storedAuth !== null && ((storedAuth === 'true') === authenticated)) {\n        return;\n      }\n      if (authenticated) {\n        localStorage.setItem(REQUIRE_UPDATE_KEY, 'true');\n        sessionStorage.setItem(AUTH_KEY, 'true');\n      } else {\n        sessionStorage.setItem(AUTH_KEY, 'false');\n        savePersonalizationData({\n          segments: [],\n          groups: [],\n          cartRules: [],\n        });\n      }\n    }, { eager: true }),\n    events.on('cart/updated', async (cart) => {\n      const enabled = await isEnabled();\n      if (cart === null || !enabled) {\n        return;\n      }\n      updatePersonalizationData(cart.id);\n    }, { eager: true }),\n    events.on('cart/initialized', async (cart) => {\n      const enabled = await isEnabled();\n      if (cart === null || !enabled) {\n        return;\n      }\n      const value = localStorage.getItem(REQUIRE_UPDATE_KEY);\n      const flag = value !== null ? (value === 'true') : false;\n      if (flag) {\n        updatePersonalizationData(cart.id);\n        localStorage.setItem(REQUIRE_UPDATE_KEY, 'false');\n      }\n    }, { eager: true }),\n    events.on('order/placed', async () => {\n      const enabled = await isEnabled();\n      if (!enabled) {\n        return;\n      }\n      localStorage.setItem(REQUIRE_UPDATE_KEY, 'true');\n    }, { eager: true }),\n  ],\n});\n\nexport const config = initialize.config;\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { PersonalizationData } from '@/personalization/data/models';\n\nexport function transformVisitorData(data: any): PersonalizationData {\n  if (!data) return {\n    groups: [],\n    segments: [],\n    cartRules: []\n  };\n\n  return {\n    groups: [data.customerGroup.uid],\n    segments: transformItems(data.customerSegments),\n    cartRules: transformItems(data.cart.rules),\n  };\n}\n\nfunction transformItems(data: any): string[] {\n  if (!data.length) return [];\n\n  return data.map((item: any) => (item.uid));\n}\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nexport const PERSONALIZATION_DATA_QUERY = `\nquery PERSONALIZATION_DATA(\n      $cartId: String!\n    ) {\n      customerGroup {\n        uid\n      }\n      customerSegments(cartId: $cartId) {\n        uid\n      }\n      cart(cart_id: $cartId) {\n        rules {\n          uid\n        }\n      }\n    }\n`;\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { fetchGraphQl } from '@/personalization/api';\nimport { PersonalizationData } from '@/personalization/data/models';\nimport { transformVisitorData } from '@/personalization/data/transforms';\nimport { handleFetchError } from '@/personalization/lib/fetch-error';\n\nimport { PERSONALIZATION_DATA_QUERY } from './graphql/PersonalizationDataQuery';\n\nexport const fetchPersonalizationData = async (cartId: string): Promise<PersonalizationData | null> => {\n  return fetchGraphQl(PERSONALIZATION_DATA_QUERY, {\n    variables: { cartId }\n  }).then(({ errors, data }) => {\n    if (errors) return handleFetchError(errors);\n\n    return transformVisitorData(data);\n  });\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2025 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { PersonalizationData } from '@/personalization/data/models';\nimport { resetTypes } from \"@/personalization/lib/type-registry\";\nimport { events } from \"@adobe-commerce/event-bus\";\nimport { getCookie, setCookie } from \"@/personalization/lib/cookieUtils\";\n\nexport const savePersonalizationData = async (data: PersonalizationData): Promise<void> => {\n  resetTypes();\n  const currentData = getCookie()\n  const newData = JSON.stringify(data);\n  if (currentData !== newData) {\n    await setCookie(newData);\n    events.emit('personalization/updated', data);\n  }\n}\n"],"names":["REQUIRE_UPDATE_KEY","AUTH_KEY","updatePersonalizationData","cartId","data","fetchPersonalizationData","savePersonalizationData","isEnabled","config","getStoreConfig","initialize","Initializer","defaultConfig","events","authenticated","storedAuth","cart","enabled","value","transformVisitorData","transformItems","item","PERSONALIZATION_DATA_QUERY","fetchGraphQl","errors","handleFetchError","resetTypes","currentData","getCookie","newData","setCookie"],"mappings":"mTA0BA,MAAMA,EAAqB,gDACrBC,EAAW,gCAEXC,EAA4B,MAAOC,GAAmB,CACpD,MAAAC,EAAO,MAAMC,EAAyBF,CAAM,EAC9CC,IAAS,MACXE,EAAwBF,CAAI,CAEhC,EAEMG,EAAY,SAAY,CACtBC,MAAAA,EAAS,MAAMC,EAAe,EACpC,OAAOD,GAAAA,YAAAA,EAAQ,sBAAuBA,EAAO,oBAAsBA,EAAO,oBAC5E,EAEaE,EAAa,IAAIC,EAAyB,CACrD,KAAM,MAAOH,GAAW,CACtB,MAAMI,EAAgB,CAAC,EAEvBF,EAAW,OAAO,UAAU,CAAE,GAAGE,EAAe,GAAGJ,EAAQ,CAC7D,EAEA,UAAW,IAAM,CACfK,EAAO,GAAG,gBAAiB,MAAOC,GAAkB,CAElD,GAAI,CADY,MAAMP,EAAU,EAE9B,OAEI,MAAAQ,EAAa,eAAe,QAAQd,CAAQ,EAC9Cc,IAAe,MAAUA,IAAe,SAAYD,IAGpDA,GACW,aAAA,QAAQd,EAAoB,MAAM,EAChC,eAAA,QAAQC,EAAU,MAAM,IAExB,eAAA,QAAQA,EAAU,OAAO,EAChBK,EAAA,CACtB,SAAU,CAAC,EACX,OAAQ,CAAC,EACT,UAAW,CAAA,CAAC,CACb,GACH,EACC,CAAE,MAAO,GAAM,EAClBO,EAAO,GAAG,eAAgB,MAAOG,GAAS,CAClC,MAAAC,EAAU,MAAMV,EAAU,EAC5BS,IAAS,MAAQ,CAACC,GAGtBf,EAA0Bc,EAAK,EAAE,CAAA,EAChC,CAAE,MAAO,GAAM,EAClBH,EAAO,GAAG,mBAAoB,MAAOG,GAAS,CACtC,MAAAC,EAAU,MAAMV,EAAU,EAC5B,GAAAS,IAAS,MAAQ,CAACC,EACpB,OAEI,MAAAC,EAAQ,aAAa,QAAQlB,CAAkB,GACxCkB,IAAU,KAAQA,IAAU,OAAU,MAEjDhB,EAA0Bc,EAAK,EAAE,EACpB,aAAA,QAAQhB,EAAoB,OAAO,EAClD,EACC,CAAE,MAAO,GAAM,EAClBa,EAAO,GAAG,eAAgB,SAAY,CACpB,MAAMN,EAAU,GAInB,aAAA,QAAQP,EAAoB,MAAM,CAAA,EAC9C,CAAE,MAAO,EAAM,CAAA,CAAA,CAEtB,CAAC,EAEYQ,EAASE,EAAW,OChF1B,SAASS,EAAqBf,EAAgC,CAC/D,OAACA,EAME,CACL,OAAQ,CAACA,EAAK,cAAc,GAAG,EAC/B,SAAUgB,EAAehB,EAAK,gBAAgB,EAC9C,UAAWgB,EAAehB,EAAK,KAAK,KAAK,CAC3C,EAVkB,CAChB,OAAQ,CAAC,EACT,SAAU,CAAC,EACX,UAAW,CAAA,CACb,CAOF,CAEA,SAASgB,EAAehB,EAAqB,CAC3C,OAAKA,EAAK,OAEHA,EAAK,IAAKiB,GAAeA,EAAK,GAAI,EAFhB,CAAC,CAG5B,CCpBO,MAAMC,EAA6B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,ECO7BjB,EAA2B,MAAOF,GACtCoB,EAAaD,EAA4B,CAC9C,UAAW,CAAE,OAAAnB,CAAO,CACrB,CAAA,EAAE,KAAK,CAAC,CAAE,OAAAqB,EAAQ,KAAApB,KACboB,EAAeC,EAAiBD,CAAM,EAEnCL,EAAqBf,CAAI,CACjC,ECTUE,EAA0B,MAAOF,GAA6C,CAC9EsB,EAAA,EACX,MAAMC,EAAcC,EAAU,EACxBC,EAAU,KAAK,UAAUzB,CAAI,EAC/BuB,IAAgBE,IAClB,MAAMC,EAAUD,CAAO,EAChBhB,EAAA,KAAK,0BAA2BT,CAAI,EAE/C"}