/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as t,jsxs as I,Fragment as he}from"@dropins/tools/preact-jsx-runtime.js";import{useState as _,useCallback as k,useEffect as se,useMemo as me,useRef as ie}from"@dropins/tools/preact-hooks.js";import{classes as le,VComponent as fe}from"@dropins/tools/lib.js";import{Button as K,Icon as Pe,Skeleton as we,SkeletonRow as Ee,Picker as ke,Checkbox as Te,Card as ue,Header as Ne,InLineAlert as pe,Field as Se,Input as xe,ProgressSpinner as ye,Modal as De,IllustratedMessage as ge}from"@dropins/tools/components.js";import{u as Ce}from"../chunks/useCompanyContextListener.js";import{g as be,a as Ie,c as Fe,u as Me,d as Be,i as ve}from"../chunks/isCompanyRoleNameAvailable.js";import{a as Re,b as Le}from"../chunks/company-permissions.js";import{f as Ue}from"../chunks/fetchUserPermissions.js";import{u as Oe}from"../chunks/useInLineAlert.js";import{useText as ne}from"@dropins/tools/i18n.js";import{Fragment as ze}from"@dropins/tools/preact.js";import"@dropins/tools/event-bus.js";import"../chunks/fetch-error.js";import"../chunks/fetch-graphql.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/preact-compat.js";const $e=({className:d,children:l,columns:r=[],rowData:m=[],mobileLayout:n="none",caption:p,expandedRows:B=new Set,loading:C=!1,skeletonRowCount:y=10,onSortChange:A,...u})=>{const g=ne({sortedAscending:"Dropin.Table.sortedAscending",sortedDescending:"Dropin.Table.sortedDescending",sortBy:"Dropin.Table.sortBy"}),L=a=>{if(!A)return;let h;a.sortBy===!0?h="asc":a.sortBy==="asc"?h="desc":h=!0,A(a.key,h)},T=a=>{if(a.sortBy===void 0)return null;let h,R;return a.sortBy==="asc"?(h="ChevronUp",R=g.sortedAscending.replace("{label}",a.label)):a.sortBy==="desc"?(h="ChevronDown",R=g.sortedDescending.replace("{label}",a.label)):(h="Sort",R=g.sortBy.replace("{label}",a.label)),t(K,{variant:"tertiary",size:"medium",className:"dropin-table__header__sort-button",icon:t(Pe,{source:h}),"aria-label":R,onClick:()=>L(a)})},$=()=>Array.from({length:y},(a,h)=>t("tr",{className:"dropin-table__body__row",children:r.map(R=>t("td",{className:"dropin-table__body__cell","data-label":R.label,children:t(we,{children:t(Ee,{variant:"row",size:"small",fullWidth:!0})})},R.key))},`skeleton-${h}`)),w=()=>m.map((a,h)=>{const R=a._rowDetails!==void 0,H=B.has(h);return I(ze,{children:[t("tr",{className:"dropin-table__body__row",children:r.map(F=>{const E=a[F.key];return typeof E=="string"||typeof E=="number"?t("td",{className:"dropin-table__body__cell","data-label":F.label,children:E},F.key):t("td",{className:"dropin-table__body__cell","data-label":F.label,children:t(fe,{node:E})},F.key)})}),R&&H&&t("tr",{className:"dropin-table__row-details dropin-table__row-details--expanded",id:`row-${h}-details`,children:t("td",{className:"dropin-table__row-details__cell",colSpan:r.length,role:"region","aria-labelledby":`row-${h}-details`,children:typeof a._rowDetails=="string"?a._rowDetails:t(fe,{node:a._rowDetails})})},`${h}-details`)]},h)}),V=a=>{if(a.sortBy===!0)return"none";if(a.sortBy==="asc")return"ascending";if(a.sortBy==="desc")return"descending"};return t("div",{className:le(["dropin-table",`dropin-table--mobile-layout-${n}`,d]),children:I("table",{...u,className:"dropin-table__table",children:[p&&t("caption",{className:"dropin-table__caption",children:p}),t("thead",{className:"dropin-table__header",children:t("tr",{className:"dropin-table__header__row",children:r.map(a=>I("th",{className:le(["dropin-table__header__cell",["dropin-table__header__cell--sorted",a.sortBy==="asc"||a.sortBy==="desc"],["dropin-table__header__cell--sortable",a.sortBy!==void 0]]),"aria-sort":V(a),children:[a.label,T(a)]},a.key))})}),t("tbody",{className:"dropin-table__body",children:C?$():w()})]})})},te=20,Ve=(d=te,l=!0,r=!1)=>{const[m,n]=_([]),[p,B]=_([]),[C,y]=_(0),[A,u]=_(1),[g,L]=_(d),[T,$]=_(1),[w,V]=_(!1),[a,h]=_(!1),[R,H]=_(!1),[F,E]=_(!1),[q,P]=_(null),N=k(async(e={})=>{V(!0),P(null);try{if(r){const s=await be({pageSize:1e3,currentPage:1,...e});n(s.items),y(s.totalCount),$(1),u(1)}else{const s=await be({pageSize:g,currentPage:A,...e});n(s.items),y(s.totalCount),$(s.pageInfo.totalPages),u(s.pageInfo.currentPage)}}catch(s){P(s instanceof Error?s.message:"Failed to fetch roles")}finally{V(!1)}},[r,g,A]),U=k(async()=>{try{const e=await Ie();B(e)}catch(e){P(e instanceof Error?e.message:"Failed to fetch ACL resources")}},[]),j=k(async e=>{h(!0),P(null);try{const s=await Fe(e);return await N(),s}catch(s){return P(s instanceof Error?s.message:"Failed to create role"),null}finally{h(!1)}},[N]),o=k(async e=>{H(!0),P(null);try{const s=await Me(e);return n(i=>i.map(b=>b.id===s.id?s:b)),s}catch(s){return P(s instanceof Error?s.message:"Failed to update role"),null}finally{H(!1)}},[]),x=k(async e=>{E(!0),P(null);try{const s=await Be({id:e});return s&&(n(i=>i.filter(b=>b.id!==e)),y(i=>i-1)),s}catch(s){return P(s instanceof Error?s.message:"Failed to delete role"),!1}finally{E(!1)}},[]),O=k(async e=>{try{return await ve({name:e})}catch(s){return P(s instanceof Error?s.message:"Failed to check role name availability"),!1}},[]),G=k(e=>{u(e)},[]),W=k(e=>{L(e),u(1)},[]),X=k(async()=>{await Promise.all([N(),U()])},[N,U]),Z=k(()=>{P(null)},[]);return se(()=>{if(l){const e=setTimeout(()=>{N()},100);return()=>clearTimeout(e)}},[N,l]),se(()=>{if(l){const e=setTimeout(()=>{U()},100);return()=>clearTimeout(e)}},[U,l]),Ce(k(async()=>{u(1),await X()},[X]),{eager:!0}),{roles:m,aclResources:p,totalCount:C,currentPage:A,pageSize:g,totalPages:T,isLoading:w,isCreating:a,isUpdating:R,isDeleting:F,error:q,fetchRoles:N,fetchAclResources:U,createRole:j,updateRole:o,deleteRole:x,checkRoleNameAvailability:O,setPage:G,setPageSize:W,refresh:X,clearError:Z}},He=d=>{try{if(/^\d+$/.test(d))return d;const r=atob(d).match(/(\d+)$/);return r?r[1]:d}catch(l){return console.warn("Failed to decode role ID:",d,l),d}},qe=({className:d,roles:l,isLoading:r,canManageRoles:m=!1,onShowCreateForm:n,onShowEditForm:p,onDuplicateRole:B,onDeleteRole:C,totalCount:y=l.length,currentPage:A=1,pageSize:u=te,onPageChange:g,onPageSizeChange:L,children:T,...$})=>{const w=ne({addNewRole:"Company.RoleAndPermissionTable.addNewRole",columnId:"Company.RoleAndPermissionTable.columnId",columnRole:"Company.RoleAndPermissionTable.columnRole",columnUsers:"Company.RoleAndPermissionTable.columnUsers",columnActions:"Company.RoleAndPermissionTable.columnActions",editButton:"Company.RoleAndPermissionTable.editButton",duplicateButton:"Company.RoleAndPermissionTable.duplicateButton",deleteButton:"Company.RoleAndPermissionTable.deleteButton",viewOnlyLabel:"Company.RoleAndPermissionTable.viewOnlyLabel",systemRoleLabel:"Company.RoleAndPermissionTable.systemRoleLabel",itemCount:"Company.RoleAndPermissionTable.itemCount",show:"Company.RoleAndPermissionTable.show",perPage:"Company.RoleAndPermissionTable.perPage"}),V=[{key:"id",label:w.columnId||"ID"},{key:"name",label:w.columnRole||"Role"},{key:"usersCount",label:w.columnUsers||"Users"},{key:"actions",label:w.columnActions||"Actions"}],a=k(o=>m&&o.id!=="0",[m]),h=k(o=>m&&o.id!=="0",[m]),R=k(o=>m&&o.id!=="0"&&y>1,[m,y]),H=k(o=>{const x=[];return a(o)&&x.push(t(K,{variant:"tertiary",size:"medium",onClick:()=>p(o.id),className:"role-action-button",children:w.editButton||"Edit"},"edit")),h(o)&&B&&x.push(t(K,{variant:"tertiary",size:"medium",onClick:()=>B(o.id),className:"role-action-button",children:w.duplicateButton||"Duplicate"},"duplicate")),R(o)&&C&&x.push(t(K,{variant:"tertiary",size:"medium",onClick:()=>C(o.id),className:"role-action-button",children:w.deleteButton||"Delete"},"delete")),x.length===0?m?t("span",{className:"no-actions",children:w.systemRoleLabel||"System Role"}):null:t("div",{className:"role-actions-container",children:x.map((O,G)=>I("span",{className:"role-action-wrapper",children:[G>0&&t("span",{className:"separator",children:"|"}),O]},G))})},[a,h,R,p,B,C,w,m]),F=me(()=>l.map(o=>({id:He(o.id),name:o.name,usersCount:o.usersCount,actions:t("div",{className:"roles-actions",children:H(o)})})),[l,H]),E=[te,30,50,100,200].map(o=>({value:o.toString(),label:o.toString(),text:o.toString()})),q=Math.ceil(y/u),P=A<q,N=A>1,U=(A-1)*u,j=U+u;return I("div",{...$,className:le(["company-management-role-and-permission-table",d]),"data-testid":"role-and-permission-table",children:[t("div",{className:"roles-table-container",children:t($e,{columns:V,rowData:F,mobileLayout:"none",loading:r,skeletonRowCount:10})}),I("div",{className:"table-footer",children:[t("div",{className:"table-footer-left",children:I("span",{className:"item-count",children:["Items ",U+1," to ",Math.min(j,y)," of ",y," total"]})}),q>1&&t("div",{className:"table-footer-center",children:I("div",{className:"page-navigation",children:[t(K,{variant:"tertiary",size:"medium",onClick:()=>g==null?void 0:g(A-1),disabled:!N,className:"page-nav-button",children:"<"}),t("span",{className:"page-info",children:A}),t(K,{variant:"tertiary",size:"medium",onClick:()=>g==null?void 0:g(A+1),disabled:!P,className:"page-nav-button",children:">"})]})}),t("div",{className:"table-footer-right",children:I("div",{className:"pagination-controls",children:[t("span",{className:"pagination-label",children:w.show||"Show"}),t(ke,{value:u.toString(),onChange:o=>{const x=o.target;L==null||L(parseInt(x.value,10))},options:E,className:"page-size-picker",placeholder:"Select page size"}),t("span",{className:"pagination-label",children:w.perPage||"per page"})]})})]}),m&&t("div",{className:"add-role-section",children:t(K,{variant:"primary",onClick:n,children:w.addNewRole||"Add New Role"})}),T]})},je=(d,l=!1)=>{const r=new Map;for(const m of d){const n=m.parentId??null,p=r.get(n)??[];p.push(m),r.set(n,p)}if(!l)for(const[,m]of r)m.sort((n,p)=>n.label.localeCompare(p.label));return r},Ge=({items:d,rootId:l=null,className:r,expandedIds:m,selectedId:n=null,selectedIds:p,onExpandedChange:B,onSelectedChange:C,onSelectedIdsChange:y,renderNode:A,role:u="tree",preserveOrder:g=!1,draggable:L,canDrop:T,onMove:$,isCheckable:w,checkedIds:V,onCheckedChange:a,biDirectionalChecking:h=!1,renderExpander:R,renderCheckbox:H,renderIcon:F})=>{const E=me(()=>je(d,g),[d,g]),q=ie(null),P=ie(!1),N=me(()=>new Map(d.map(e=>[e.id,e])),[d]),U=(e,s)=>{const i=[],b=[s];for(;b.length;){const f=b.pop(),S=e.get(f)??[];for(const v of S)i.push(v.id),b.push(v.id)}return i},j=k(e=>U(E,e),[E]),o=k(e=>w?w(e):!0,[w]),x=k(e=>{if(!N.get(e))return{checked:!1,indeterminate:!1};const i=V??new Set;if(h){if(i.has(e))return{checked:!0,indeterminate:!1};const S=j(e).filter(z=>{const Y=N.get(z);return Y?o(Y):!1});return S.length===0?{checked:!1,indeterminate:!1}:S.reduce((z,Y)=>i.has(Y)?z+1:z,0)===0?{checked:!1,indeterminate:!1}:{checked:!1,indeterminate:!0}}const b=[e,...j(e)].filter(S=>{const v=N.get(S);return v?o(v):!1});if(b.length===0)return{checked:!1,indeterminate:!1};const f=b.reduce((S,v)=>i.has(v)?S+1:S,0);return f===0?{checked:!1,indeterminate:!1}:f===b.length?{checked:!0,indeterminate:!1}:{checked:!1,indeterminate:!0}},[N,j,o,V,h]),O=k(e=>{if(!a)return;const s=new Set(V??[]),{checked:i}=x(e),b=j(e),f=[e,...b].filter(S=>{const v=N.get(S);return v?o(v):!1});if(i)for(const S of f)s.delete(S);else for(const S of f)s.add(S);if(h){const S=N.get(e);if(S){let v=S.parentId;for(;v;){const z=N.get(v);if(!z||!o(z))break;i?(E.get(v)??[]).some(J=>o(J)&&s.has(J.id))||s.delete(v):s.add(v),v=z.parentId}}}a(s)},[V,a,x,j,N,E,o,h]),G=k(e=>t(Te,{name:`tree-checkbox-${Math.random().toString(36).substr(2,9)}`,checked:e.checked,indeterminate:e.indeterminate,onChange:e.onCheck}),[]),W=k(e=>{const s=new Set(m);s.has(e)?s.delete(e):s.add(e),B(s)},[m,B]),X=k(e=>{const s=N.get(e);if(s&&o(s)&&a&&O(e),!y){C==null||C(e);return}const i=!!P.current,b=i?new Set(p??[]):new Set;i&&b.has(e)?b.delete(e):b.add(e),y(b),P.current=!1},[C,y,p,N,o,a,O]),Z=(e,s)=>{const i=E.get(e)??[];return i.length?t("ul",{role:s===1?u:"group",className:s===1?r??"acm-tree":"acm-tree__group",children:i.map((f,S)=>{const v=(E.get(f.id)??[]).length>0,z=m.has(f.id),Y=p?p.has(f.id):n===f.id,ee=!!(L!=null&&L(f)),J=M=>T?T(M,f.id):M!==f.id,re=v?()=>R?R({expanded:z,hasChildren:v,toggle:()=>W(f.id)}):null:void 0,ae=(()=>{if(!a)return;const M=N.get(f.id);if(!M||!o(M))return;const c=x(f.id),D=H||G;return()=>D({checked:c.checked,indeterminate:c.indeterminate,onCheck:()=>O(f.id)})})(),oe=F?()=>F({item:f,level:s,hasChildren:v,expanded:z}):void 0,ce=A({item:f,level:s,expanded:z,selected:!!Y,hasChildren:v,toggle:()=>W(f.id),select:()=>X(f.id),...re?{expander:re}:{},...ae?{checkbox:ae}:{},...oe?{icon:oe}:{}});return I("li",{role:"treeitem",className:"acm-tree__item","data-level":s,"aria-expanded":v?z:void 0,"aria-selected":Y||void 0,"aria-level":s,"aria-setsize":i.length,"aria-posinset":S+1,draggable:ee,onMouseDown:M=>{P.current=!!(M.metaKey||M.ctrlKey)},onDragStart:M=>{var c;if(M.stopPropagation(),!!ee){q.current=f.id;try{(c=M.dataTransfer)==null||c.setData("text/plain",f.id)}catch{}}},onDragOver:M=>{var D;M.stopPropagation();const c=q.current??(((D=M.dataTransfer)==null?void 0:D.getData("text/plain"))||"");c&&J(c)&&M.preventDefault()},onDrop:M=>{var D;M.stopPropagation();const c=q.current??(((D=M.dataTransfer)==null?void 0:D.getData("text/plain"))||"");q.current=null,c&&J(c)&&($==null||$({id:c,newParentId:f.id}))},children:[ce,v&&z?Z(f.id,s+1):null]},f.id)})}):null};return t("div",{className:"acm-tree-root",children:Z(l,1)})},Ke={MAX_LENGTH:40},de=d=>(typeof d=="string"?d:String(d||"")).trim().slice(0,Ke.MAX_LENGTH),_e=({mode:d,role:l,aclResources:r,existingRoleNames:m=[],loading:n=!1,onSubmit:p,onCancel:B,inLineAlertProps:C,prefillName:y,prefillPermissions:A})=>{const u=ne({createTitle:"Company.EditRoleAndPermission.createTitle",editTitle:"Company.EditRoleAndPermission.editTitle",roleInformation:"Company.EditRoleAndPermission.roleInformation",roleName:"Company.EditRoleAndPermission.roleName",rolePermissions:"Company.EditRoleAndPermission.rolePermissions",permissionsDescription:"Company.EditRoleAndPermission.permissionsDescription",expandAll:"Company.EditRoleAndPermission.expandAll",collapseAll:"Company.EditRoleAndPermission.collapseAll",cancel:"Company.shared.buttons.cancel",saveRole:"Company.EditRoleAndPermission.saveRole",saving:"Company.shared.buttons.saving",roleNameRequired:"Company.shared.validation.roleNameRequired",roleNameExists:"Company.shared.validation.roleNameExists"}),[g,L]=_({name:(l==null?void 0:l.name)||""}),[T,$]=_({}),[w,V]=_({}),[a,h]=_(!1),[R,H]=_(!1),[F,E]=_([]),[q,P]=_(new Set),[N,U]=_(new Set);se(()=>{if(d==="edit"&&l){if(L({name:l.name}),l.permissions&&l.permissions.length>0){const e=Re(l.permissions);U(new Set(e))}}else if(d==="create")if(L({name:y??""}),A&&A.length>0){const s=Re(A);U(new Set(s))}else U(new Set)},[d,l,y,A]),se(()=>{if(r.length>0){const e=Xe(r);E(e);const s=e.filter(i=>!i.parentId).map(i=>i.id);P(new Set(s))}},[r]);const j=e=>{const s=de(e);return s?(d==="edit"&&l?m.filter(b=>b!==l.name):m).includes(s)?u.roleNameExists:null:u.roleNameRequired||"This is a required field."},o=async e=>{const s=de(e),i=j(s);if(i)return i;if(d==="edit"&&l&&s===l.name)return null;try{return h(!0),await ve({name:s})?null:u.roleNameExists}catch(b){return console.error("Role name validation failed:",b),null}finally{h(!1)}},x=()=>{const e={};let s=!0;const i=j(g.name);return i&&(e.name=i,s=!1),$(e),s},O=e=>{const s=typeof e=="string"?e:e.target.value;L(i=>({...i,name:s})),T.name&&$(i=>({...i,name:""}))},G=()=>{const e=new Set(F.map(s=>s.id));P(e)},W=()=>{P(new Set)},X=async e=>{e.preventDefault(),V({name:!0}),H(!0);try{const s=await o(g.name);if(s){$(b=>({...b,name:s}));return}if(!x())return;const i={name:de(g.name),permissions:Array.from(N)};p&&await p(i)}catch(s){console.error("Form submission failed:",s)}finally{H(!1)}},Z=d==="create"?u.createTitle:u.editTitle;return I(ue,{variant:"secondary",className:"edit-role-and-permission",children:[t(Ne,{title:Z,divider:!1,className:"edit-role-and-permission__title"}),(C==null?void 0:C.text)&&t(pe,{className:"edit-role-and-permission__notification",type:C.type,variant:"secondary",heading:C.text,"data-testid":"editRoleInLineAlert"}),I("form",{className:"edit-role-and-permission-form",onSubmit:X,children:[I("div",{className:"edit-role-and-permission__section",children:[t("h3",{className:"edit-role-and-permission__section-title",children:u.roleInformation||"Role Information"}),t(Se,{label:u.roleName||"Role Name",required:!0,error:w.name&&T.name?T.name:void 0,children:t(xe,{type:"text",name:"roleName",value:g.name,onChange:O,onBlur:e=>{const s=e.target;O(s.value)},disabled:n||R,"data-testid":"roleNameInput",placeholder:u.roleName||"Role Name",variant:"primary",size:"medium",maxLength:40})}),a&&t("div",{className:"edit-role-and-permission__validation-spinner",children:t(ye,{size:"medium"})})]}),I("div",{className:"edit-role-and-permission__section",children:[t("h3",{className:"edit-role-and-permission__section-title",children:u.rolePermissions}),t("p",{className:"edit-role-and-permission__permissions-description",children:u.permissionsDescription}),I("div",{className:"edit-role-and-permission__tree-controls",children:[t(K,{type:"button",variant:"tertiary",onClick:G,disabled:n||R,children:u.expandAll}),t(K,{type:"button",variant:"tertiary",onClick:W,disabled:n||R,children:u.collapseAll})]}),t("div",{className:"edit-role-and-permission__tree-container",role:"group","aria-label":u.rolePermissions,children:F.length>0?t(Ge,{items:F,expandedIds:q,onExpandedChange:P,checkedIds:N,onCheckedChange:U,preserveOrder:!0,isCheckable:()=>!0,biDirectionalChecking:!0,renderNode:({item:e,expanded:s,hasChildren:i,toggle:b,checkbox:f})=>I("div",{className:"edit-role-and-permission__tree-node",children:[i&&t("button",{type:"button",className:"edit-role-and-permission__tree-expander",onClick:b,"aria-label":s?`Collapse ${e.label}`:`Expand ${e.label}`,children:s?"âˆ’":"+"}),f&&f(),t("span",{className:"edit-role-and-permission__tree-label",children:e.label})]})}):t("div",{className:"edit-role-and-permission__tree-loading",children:"Loading permissions..."})})]}),I("div",{className:"edit-role-and-permission__actions",children:[t(K,{type:"button",variant:"secondary",onClick:B,disabled:n||R,children:u.cancel}),t(K,{type:"submit",variant:"primary",disabled:n||R||a,children:n||R?u.saving:u.saveRole})]})]}),(n||R)&&I("div",{className:"edit-role-and-permission__loading-overlay",children:[t(ye,{size:"large"}),t("div",{className:"edit-role-and-permission__loading-text",children:u.saving})]})]})},Xe=d=>{const l=[],r=(n,p)=>{l.push({id:n.id,parentId:p||null,label:n.text}),n.children&&[...n.children].sort((C,y)=>C.sortOrder-y.sortOrder).forEach(C=>{r(C,n.id)})};return[...d].sort((n,p)=>n.sortOrder-p.sortOrder).forEach(n=>r(n)),l},Ye=({isOpen:d,hasUsers:l=!1,onConfirm:r,onCancel:m})=>{const n=ne({deleteModalTitle:"Company.RolesAndPermissions.deleteModal.title",deleteModalMessage:"Company.RolesAndPermissions.deleteModal.message",deleteModalConfirm:"Company.RolesAndPermissions.deleteModal.confirm",deleteModalCancel:"Company.RolesAndPermissions.deleteModal.cancel",cannotDeleteModalTitle:"Company.RolesAndPermissions.cannotDeleteModal.title",cannotDeleteModalMessage:"Company.RolesAndPermissions.cannotDeleteModal.message",cannotDeleteModalOk:"Company.RolesAndPermissions.cannotDeleteModal.ok"});if(!d)return null;const p=l?n.cannotDeleteModalMessage||"This role cannot be deleted because users are assigned to it. Reassign the users to another role to continue.":n.deleteModalMessage||"This action cannot be undone. Are you sure you want to delete this role?";return I(De,{open:!0,onClose:m,title:t(he,{children:l?n.cannotDeleteModalTitle||"Cannot Delete Role":n.deleteModalTitle||"Delete This Role?"}),size:"small",className:"delete-role-modal",children:[t("div",{className:"delete-role-modal__content",children:t("p",{children:p})}),t("div",{className:"delete-role-modal__actions",children:l?t(K,{variant:"primary",onClick:r,className:"delete-role-modal__ok-btn",children:n.cannotDeleteModalOk||"OK"}):I(he,{children:[t(K,{variant:"secondary",onClick:m,className:"delete-role-modal__cancel-btn",children:n.deleteModalCancel||"Cancel"}),t(K,{variant:"primary",onClick:r,className:"delete-role-modal__confirm-btn",children:n.deleteModalConfirm||"Delete"})]})})]})},We=()=>{const[d,l]=_(null),[r,m]=_(!0),[n,p]=_(null),B=ie(!1),C=ie(!1),y=k(async()=>{var A,u;if(!B.current){B.current=!0,m(!0),p(null);try{const{roleResponse:g}=await Ue(),L=(u=(A=g==null?void 0:g.data)==null?void 0:A.customer)==null?void 0:u.role,T=Le(L);l(T)}catch(g){console.error("Failed to fetch user permissions:",g),p(g)}finally{m(!1),B.current=!1}}},[]);return se(()=>{C.current||(C.current=!0,y())},[y]),{permissions:d,loading:r,error:n,refetch:y}},ps=({className:d,withHeader:l=!1})=>{const r=ne({containerTitle:"Company.RolesAndPermissions.containerTitle",noAccessTitle:"Company.RolesAndPermissions.noAccess.title",noAccessMessage:"Company.RolesAndPermissions.noAccess.message",errorTitle:"Company.RolesAndPermissions.error.title",errorMessage:"Company.RolesAndPermissions.error.message",deleteRoleSuccess:"Company.RoleAndPermissionTable.deleteRole.success",createSuccess:"Company.RolesAndPermissions.alerts.createSuccess",createError:"Company.RolesAndPermissions.alerts.createError",createErrorPermissions:"Company.RolesAndPermissions.alerts.createErrorPermissions",updateSuccess:"Company.RolesAndPermissions.alerts.updateSuccess",updateError:"Company.RolesAndPermissions.alerts.updateError",updateErrorPermissions:"Company.RolesAndPermissions.alerts.updateErrorPermissions",deleteError:"Company.RolesAndPermissions.alerts.deleteError"}),{inLineAlertProps:m,handleSetInLineAlert:n}=Oe(),{permissions:p,loading:B,error:C}=We(),{roles:y,aclResources:A,isLoading:u,isCreating:g,isUpdating:L,error:T,createRole:$,updateRole:w,deleteRole:V,clearError:a}=Ve(te,!0,!0),[h,R]=_(!1),[H,F]=_(!1),[E,q]=_(null),[P,N]=_(1),[U,j]=_(te),[o,x]=_(null),[O,G]=_(null);se(()=>()=>{T&&a(),G(null)},[T,a]),Ce(()=>{N(1),H&&(F(!1),q(null)),x(null),a()},{eager:!0});const W=(p==null?void 0:p.canViewRoles)??!1,X=(p==null?void 0:p.canManageRoles)??!1,Z=W||X;if(B)return t("div",{"data-testid":"rolesAndPermissionsLoader",children:t("div",{children:"Loading..."})});if(C)return t(ue,{variant:"secondary",className:"roles-and-permissions-error",children:t("div",{className:"roles-and-permissions-error__wrapper",children:t("div",{className:"roles-and-permissions-error__content",children:t(ge,{heading:r.errorTitle||"Error Loading Permissions",message:t("p",{children:r.errorMessage||"An error occurred while loading your permissions. Please try again."})})})})});if(!Z)return t(ue,{variant:"secondary",className:"roles-and-permissions-no-access",children:t("div",{className:"roles-and-permissions-no-access__wrapper",children:t("div",{className:"roles-and-permissions-no-access__content",children:t(ge,{heading:r.noAccessTitle||"Access Restricted",message:t("p",{children:r.noAccessMessage||"You don't have permission to view roles and permissions. Please contact your company administrator."})})})})});const e=y.length,s=(P-1)*U,i=s+U,b=y.slice(s,i),f=c=>{N(c)},S=c=>{j(c),N(1)},v=()=>{G(null),R(!0)},z=()=>{G(null),R(!1)},Y=c=>{q(c),F(!0)},ee=()=>{F(!1),q(null)},J=c=>{const D=y.find(Q=>Q.id===c);D&&(G({name:`${D.name} - Duplicated`,permissions:D.permissions||[]}),R(!0))},re=async c=>{try{if(await $({name:c.name,permissions:c.permissions})){const Q=r.createSuccess?r.createSuccess.replace("{roleName}",c.name):`Role "${c.name}" created successfully!`;n({type:"success",text:Q}),z()}else n({type:"error",text:r.createError||"Failed to create role. Please try again."})}catch{n({type:"error",text:r.createErrorPermissions||"Failed to create role. Please check your permissions and try again."})}},ae=async c=>{if(E)try{if(await w({id:E,name:c.name,permissions:c.permissions})){const Q=r.updateSuccess?r.updateSuccess.replace("{roleName}",c.name):`Role "${c.name}" updated successfully!`;n({type:"success",text:Q}),ee()}else n({type:"error",text:r.updateError||"Failed to update role. Please try again."})}catch{n({type:"error",text:r.updateErrorPermissions||"Failed to update role. Please check your permissions and try again."})}},oe=c=>{const D=y.find(Ae=>Ae.id===c);if(!D)return;const Q=D.usersCount>0;x({id:c,name:D.name,hasUsers:Q})},ce=async()=>{if(o){if(o.hasUsers){x(null);return}try{if(await V(o.id)){const D=r.deleteRoleSuccess?r.deleteRoleSuccess.replace("{roleName}",o.name||"Unknown Role"):`You have deleted role "${o.name||"Unknown Role"}".`;n({type:"success",text:D})}else n({type:"error",text:r.deleteError||"Failed to delete role. Please try again."})}catch{n({type:"error",text:r.deleteError||"Failed to delete role. Please try again."})}finally{x(null)}}},M=()=>x(null);return I("div",{className:le(["roles-and-permissions",d]),children:[l?t(Ne,{title:r.containerTitle,divider:!1,className:"roles-and-permissions__title"}):null,T&&t(pe,{type:"error",heading:r.errorTitle||"Error",description:r.errorMessage||"An error occurred while loading roles and permissions.",onDismiss:a}),m&&m.text&&t(pe,{type:m.type||"success",heading:m.text,icon:m.icon}),h?t(_e,{mode:"create",aclResources:A,existingRoleNames:y.map(c=>c.name),loading:g,onSubmit:re,onCancel:()=>{G(null),z()},inLineAlertProps:T?{type:"error",text:T}:void 0,prefillName:O==null?void 0:O.name,prefillPermissions:O==null?void 0:O.permissions}):H&&E?t(_e,{mode:"edit",role:y.find(c=>c.id===E),aclResources:A,existingRoleNames:y.map(c=>c.name),loading:L,onSubmit:ae,onCancel:ee,inLineAlertProps:T?{type:"error",text:T}:void 0}):t(qe,{roles:b,isLoading:u,canManageRoles:X,onShowCreateForm:v,onShowEditForm:Y,onDuplicateRole:J,onDeleteRole:oe,totalCount:e,currentPage:P,pageSize:U,onPageChange:f,onPageSizeChange:S}),t(Ye,{isOpen:!!o,hasUsers:o==null?void 0:o.hasUsers,onConfirm:ce,onCancel:M})]})};export{ps as RolesAndPermissions,ps as default};
//# sourceMappingURL=RolesAndPermissions.js.map
