/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as a,jsxs as _}from"@dropins/tools/preact-jsx-runtime.js";import{useState as U,useRef as M,useMemo as D,useCallback as f,useEffect as F}from"@dropins/tools/preact-hooks.js";import{Button as P,InLineAlert as Z,Icon as W,Skeleton as H,SkeletonRow as J,Picker as Q,Modal as j}from"@dropins/tools/components.js";import{Fragment as X}from"@dropins/tools/preact.js";import{classes as V,VComponent as q}from"@dropins/tools/lib.js";import{useText as R}from"@dropins/tools/i18n.js";import{C as K}from"../chunks/CompanyUserForm.js";import{u as Y,b as ee}from"../chunks/useInLineAlert.js";import{g as ae,u as te}from"../chunks/updateCompanyUserStatus.js";import{d as ne}from"../chunks/updateCompanyUser.js";import{u as re}from"../chunks/useCompanyContextListener.js";import{f as se}from"../chunks/fetchUserPermissions.js";import"@dropins/tools/preact-compat.js";import"../chunks/company-permissions.js";import"../chunks/network-error.js";import"@dropins/tools/fetch-graphql.js";import"@dropins/tools/event-bus.js";const oe=(s,l)=>!s||typeof s!="string"?"":s==="ACTIVE"&&l.statusActive?l.statusActive:s==="INACTIVE"&&l.statusInactive?l.statusInactive:s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(),ie=(s,l)=>{const n=(s==null?void 0:s.trim())||"",o=(l==null?void 0:l.trim())||"";return`${n} ${o}`.trim()},le=({filterType:s,onFilterChange:l,translations:n})=>{const o=[{type:"all",label:n.showAllUsers,ariaLabel:n.showAllUsers},{type:"active",label:n.showActiveUsers,ariaLabel:n.showActiveUsers},{type:"inactive",label:n.showInactiveUsers,ariaLabel:n.showInactiveUsers}];return a("div",{className:"filterButtons",role:"group","aria-label":n.ariaFilterOptions,children:o.filter(t=>t.type!==s).map(t=>a(P,{variant:"tertiary",onClick:()=>l(t.type),"aria-label":t.ariaLabel,children:t.label},t.type))})},ce=20,G=1,me=({translations:s})=>{const[l,n]=U([]),[o,t]=U(!1),[c,C]=U(G),[h,S]=U(ce),[I,E]=U("all"),[v,u]=U(0),[b,N]=U(1),[k,L]=U(""),[e,r]=U(null),g=M(s);g.current=s;const B=D(()=>{switch(I){case"active":return{status:"ACTIVE"};case"inactive":return{status:"INACTIVE"};default:return}},[I]),d=f(async()=>{t(!0);try{const i=await ae({pageSize:h,currentPage:c,filter:B});n(i.users),u(i.totalCount||i.users.length),N(i.pageInfo.totalPages),L(g.current.ariaDataLoaded.replace("{count}",i.users.length.toString()))}catch{n([]),u(0),N(1),L(g.current.ariaDataError)}finally{t(!1)}},[h,c,B]),p=f(async()=>{try{const{allowedIds:i}=await se();r(i)}catch{r(new Set)}},[]);F(()=>{d()},[d]),F(()=>{p()},[p]);const w=f(i=>{E(i),C(G)},[]),y=f(i=>{let z;if(typeof i=="string")z=i;else if("target"in i&&i.target&&"value"in i.target)z=i.target.value;else return;const $=parseInt(z,10);isNaN($)||(S($),C(G))},[]),A=f(()=>{c>1&&C(c-1)},[c]),T=f(()=>{c<b&&C(c+1)},[c,b]),m=(e==null?void 0:e.has("Magento_Company::users_edit"))||!1,x=f(async()=>{await p(),await d()},[p,d]);return{users:l,userPermissions:e,currentPage:c,pageSize:h,totalItems:v,totalPages:b,filterType:I,filter:B,loading:o,announcement:k,canEditUsers:m,handleFilterChange:w,handlePageSizeChange:y,handlePreviousPage:A,handleNextPage:T,refreshUsers:x}},O=s=>{const[l,n]=U(!1),[o,t]=U(null),c=f(h=>{h&&t(h),n(!0)},[]),C=f(()=>{n(!1),t(null),s==null||s()},[s]);return{isOpen:l,selectedId:o,open:c,close:C}},de=({className:s,userId:l,userStatus:n,onClose:o,isOpen:t=!1,...c})=>{const[C,h]=U(!1),[S,I]=U(!1),{inLineAlertProps:E,showError:v,clearAlert:u}=Y(),b=M(null),N=M(null),k=`modal-title-${l}`,L=`modal-desc-${l}`,e=R({title:"Company.CompanyUsers.managementModal.title",setActiveText:"Company.CompanyUsers.managementModal.setActiveText",setInactiveText:"Company.CompanyUsers.managementModal.setInactiveText",deleteText:"Company.CompanyUsers.managementModal.deleteText",setActiveButton:"Company.CompanyUsers.managementModal.setActiveButton",setInactiveButton:"Company.CompanyUsers.managementModal.setInactiveButton",settingActiveButton:"Company.CompanyUsers.managementModal.settingActiveButton",settingInactiveButton:"Company.CompanyUsers.managementModal.settingInactiveButton",deleteButton:"Company.CompanyUsers.managementModal.deleteButton",deletingButton:"Company.CompanyUsers.managementModal.deletingButton",cancelButton:"Company.CompanyUsers.managementModal.cancelButton",setActiveErrorGeneric:"Company.CompanyUsers.managementModal.setActiveErrorGeneric",setActiveErrorSpecific:"Company.CompanyUsers.managementModal.setActiveErrorSpecific",setInactiveErrorGeneric:"Company.CompanyUsers.managementModal.setInactiveErrorGeneric",setInactiveErrorSpecific:"Company.CompanyUsers.managementModal.setInactiveErrorSpecific",deleteErrorGeneric:"Company.CompanyUsers.managementModal.deleteErrorGeneric",deleteErrorSpecific:"Company.CompanyUsers.managementModal.deleteErrorSpecific",ariaCloseModal:"Company.CompanyUsers.managementModal.ariaLabels.closeModal",ariaModalDescription:"Company.CompanyUsers.managementModal.ariaLabels.modalDescription"}),r=f(async()=>{if(S)return;const y=n==="ACTIVE"?"INACTIVE":"ACTIVE",A=y==="ACTIVE";I(!0),u();try{(await te({id:l,status:y})).success?o():v(A?e.setActiveErrorSpecific:e.setInactiveErrorSpecific)}catch{v(A?e.setActiveErrorGeneric:e.setInactiveErrorGeneric)}finally{I(!1)}},[l,n,o,S,u,v,e.setActiveErrorSpecific,e.setInactiveErrorSpecific,e.setActiveErrorGeneric,e.setInactiveErrorGeneric]),g=f(async()=>{if(!C){h(!0),u();try{(await ne({id:l})).success?o():v(e.deleteErrorSpecific)}catch{v(e.deleteErrorGeneric)}finally{h(!1)}}},[l,o,C,u,v,e.deleteErrorSpecific,e.deleteErrorGeneric]),B=f(()=>{u(),o()},[o,u]),d=f(y=>{if(y.key==="Escape"&&(u(),o()),y.key==="Tab"){const A=b.current;if(!A)return;const T=A.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),m=T[0],x=T[T.length-1];y.shiftKey?document.activeElement===m&&(x.focus(),y.preventDefault()):document.activeElement===x&&(m.focus(),y.preventDefault())}},[o,u]),p=f(y=>{y.target===y.currentTarget&&(u(),o())},[o,u]),w=f(()=>{u(),o()},[o,u]);return F(()=>{if(t)return N.current=document.activeElement,document.addEventListener("keydown",d),setTimeout(()=>{const y=b.current;if(y){const A=y.querySelector("button");A?A.focus():y.focus()}},100),()=>{document.removeEventListener("keydown",d)};N.current&&N.current.focus()},[t,d]),t?a("div",{className:V(["company-management-company-users-management-modal-overlay",s]),onClick:p,...c,children:_("div",{ref:b,className:"company-management-company-users-management-modal",role:"dialog","aria-modal":"true","aria-labelledby":k,"aria-describedby":L,tabIndex:-1,children:[_("div",{className:"company-management-company-users-management-modal__header",children:[a("h2",{id:k,className:"company-management-company-users-management-modal__title",children:e.title}),a("button",{className:"company-management-company-users-management-modal__close",onClick:w,"aria-label":e.ariaCloseModal,children:"Ã—"})]}),_("div",{id:L,className:"company-management-company-users-management-modal__content",children:[a("p",{className:"company-management-company-users-management-modal__text",children:n==="ACTIVE"?e.setInactiveText:e.setActiveText}),a("p",{className:"company-management-company-users-management-modal__text",children:e.deleteText})]}),(E==null?void 0:E.text)&&a("div",{className:"company-management-company-users-management-modal__alert",role:"alert","aria-live":"assertive",children:a(Z,{type:"error",heading:E.text,icon:E.icon,"data-testid":"companyUsersManagementModalAlert"})}),_("div",{className:"company-management-company-users-management-modal__actions",children:[a(P,{variant:"primary",onClick:r,disabled:S,className:"company-management-company-users-management-modal__button-primary",children:S?n==="ACTIVE"?e.settingInactiveButton:e.settingActiveButton:n==="ACTIVE"?e.setInactiveButton:e.setActiveButton}),a(P,{variant:"tertiary",onClick:g,disabled:C,className:"company-management-company-users-management-modal__button-delete",children:C?e.deletingButton:e.deleteButton}),a(P,{variant:"secondary",onClick:B,className:"company-management-company-users-management-modal__button-cancel",children:e.cancelButton})]})]})}):null},pe=({className:s,children:l,columns:n=[],rowData:o=[],mobileLayout:t="none",caption:c,expandedRows:C=new Set,loading:h=!1,skeletonRowCount:S=10,onSortChange:I,...E})=>{const v=R({sortedAscending:"Dropin.Table.sortedAscending",sortedDescending:"Dropin.Table.sortedDescending",sortBy:"Dropin.Table.sortBy"}),u=e=>{if(!I)return;let r;e.sortBy===!0?r="asc":e.sortBy==="asc"?r="desc":r=!0,I(e.key,r)},b=e=>{if(e.sortBy===void 0)return null;let r,g;return e.sortBy==="asc"?(r="ChevronUp",g=v.sortedAscending.replace("{label}",e.label)):e.sortBy==="desc"?(r="ChevronDown",g=v.sortedDescending.replace("{label}",e.label)):(r="Sort",g=v.sortBy.replace("{label}",e.label)),a(P,{variant:"tertiary",size:"medium",className:"dropin-table__header__sort-button",icon:a(W,{source:r}),"aria-label":g,onClick:()=>u(e)})},N=()=>Array.from({length:S},(e,r)=>a("tr",{className:"dropin-table__body__row",children:n.map(g=>a("td",{className:"dropin-table__body__cell","data-label":g.label,children:a(H,{children:a(J,{variant:"row",size:"small",fullWidth:!0})})},g.key))},`skeleton-${r}`)),k=()=>o.map((e,r)=>{const g=e._rowDetails!==void 0,B=C.has(r);return _(X,{children:[a("tr",{className:"dropin-table__body__row",children:n.map(d=>{const p=e[d.key];return typeof p=="string"||typeof p=="number"?a("td",{className:"dropin-table__body__cell","data-label":d.label,children:p},d.key):a("td",{className:"dropin-table__body__cell","data-label":d.label,children:a(q,{node:p})},d.key)})}),g&&B&&a("tr",{className:"dropin-table__row-details dropin-table__row-details--expanded",id:`row-${r}-details`,children:a("td",{className:"dropin-table__row-details__cell",colSpan:n.length,role:"region","aria-labelledby":`row-${r}-details`,children:typeof e._rowDetails=="string"?e._rowDetails:a(q,{node:e._rowDetails})})},`${r}-details`)]},r)}),L=e=>{if(e.sortBy===!0)return"none";if(e.sortBy==="asc")return"ascending";if(e.sortBy==="desc")return"descending"};return a("div",{className:V(["dropin-table",`dropin-table--mobile-layout-${t}`,s]),children:_("table",{...E,className:"dropin-table__table",children:[c&&a("caption",{className:"dropin-table__caption",children:c}),a("thead",{className:"dropin-table__header",children:a("tr",{className:"dropin-table__header__row",children:n.map(e=>_("th",{className:V(["dropin-table__header__cell",["dropin-table__header__cell--sorted",e.sortBy==="asc"||e.sortBy==="desc"],["dropin-table__header__cell--sortable",e.sortBy!==void 0]]),"aria-sort":L(e),children:[e.label,b(e)]},e.key))})}),a("tbody",{className:"dropin-table__body",children:h?N():k()})]})})},ye=[{text:"20",value:"20"},{text:"30",value:"30"},{text:"50",value:"50"},{text:"100",value:"100"},{text:"200",value:"200"}],Le=({children:s,className:l,...n})=>{const o=M(null),t=R({showAllUsers:"Company.CompanyUsers.filters.showAll",showActiveUsers:"Company.CompanyUsers.filters.showActive",showInactiveUsers:"Company.CompanyUsers.filters.showInactive",idColumn:"Company.CompanyUsers.columns.id",nameColumn:"Company.CompanyUsers.columns.name",emailColumn:"Company.CompanyUsers.columns.email",roleColumn:"Company.CompanyUsers.columns.role",teamColumn:"Company.CompanyUsers.columns.team",statusColumn:"Company.CompanyUsers.columns.status",actionsColumn:"Company.CompanyUsers.columns.actions",statusActive:"Company.CompanyUsers.status.active",statusInactive:"Company.CompanyUsers.status.inactive",emptyTeam:"Company.CompanyUsers.emptyTeam",emptyActions:"Company.CompanyUsers.emptyActions",itemsText:"Company.CompanyUsers.pagination.itemsCount",itemsPerPageLabel:"Company.CompanyUsers.pagination.itemsPerPage",showLabel:"Company.CompanyUsers.pagination.show",perPageLabel:"Company.CompanyUsers.pagination.perPage",previousPage:"Company.CompanyUsers.pagination.previous",nextPage:"Company.CompanyUsers.pagination.next",pageInfo:"Company.CompanyUsers.pagination.pageInfo",ariaLoadingUsers:"Company.CompanyUsers.ariaLabels.loadingUsers",ariaUsersTable:"Company.CompanyUsers.ariaLabels.usersTable",ariaFilterOptions:"Company.CompanyUsers.ariaLabels.filterOptions",ariaPaginationNav:"Company.CompanyUsers.ariaLabels.paginationNav",ariaPageSizeSelector:"Company.CompanyUsers.ariaLabels.pageSizeSelector",ariaPreviousPageFull:"Company.CompanyUsers.ariaLabels.previousPageFull",ariaNextPageFull:"Company.CompanyUsers.ariaLabels.nextPageFull",ariaCurrentPage:"Company.CompanyUsers.ariaLabels.currentPage",ariaShowingUsers:"Company.CompanyUsers.ariaLabels.showingUsers",ariaDataLoaded:"Company.CompanyUsers.ariaLabels.dataLoaded",ariaDataError:"Company.CompanyUsers.ariaLabels.dataError",ariaPageNavigation:"Company.CompanyUsers.ariaLabels.pageNavigation",manageUser:"Company.CompanyUsers.actions.manage",editUser:"Company.CompanyUsers.actions.edit",ariaManageUser:"Company.CompanyUsers.ariaLabels.manageUser",ariaEditUser:"Company.CompanyUsers.ariaLabels.editUser",addNewUser:"Company.CompanyUsers.actions.addNewUser"}),{users:c,loading:C,currentPage:h,pageSize:S,filterType:I,totalItems:E,totalPages:v,announcement:u,canEditUsers:b,handleFilterChange:N,handlePageSizeChange:k,handlePreviousPage:L,handleNextPage:e,refreshUsers:r}=me({translations:{ariaDataLoaded:t.ariaDataLoaded,ariaDataError:t.ariaDataError}}),g=M(t);g.current=t,F(()=>{!C&&o.current&&c.length>0&&o.current.setAttribute("aria-busy","false")},[C,h,I,c.length]);const B=f(()=>{r()},[r]);re(B);const d=O(r),p=O(r),w=O(r),y=D(()=>{const m=g.current;return[{key:"id",label:m.idColumn},{key:"name",label:m.nameColumn},{key:"email",label:m.emailColumn},{key:"role",label:m.roleColumn},{key:"team",label:m.teamColumn},{key:"status",label:m.statusColumn},{key:"actions",label:m.actionsColumn}]},[]),A=D(()=>c.map(m=>{const x=ie(m.firstName,m.lastName),i=g.current;return{id:m.id,name:x,email:m.email,role:m.role,team:m.team||i.emptyTeam,status:oe(m.status,i),actions:b?_("div",{className:"user-actions",children:[a(P,{variant:"tertiary",onClick:()=>p.open(m.id),"aria-label":i.ariaEditUser.replace("{name}",x),className:"edit-user-button",children:i.editUser}),a(P,{variant:"tertiary",onClick:()=>d.open(m.id),"aria-label":i.ariaManageUser.replace("{name}",x),className:"manage-user-button",children:i.manageUser})]}):a("span",{className:"no-actions",children:i.emptyActions})}}),[c,b,p,d]),T=D(()=>c.find(m=>m.id===d.selectedId),[c,d.selectedId]);return _("section",{className:l,...n,children:[a("div",{className:"sr-only",role:"status","aria-live":"polite","aria-atomic":"true",children:u}),a(le,{filterType:I,onFilterChange:N,translations:{showAllUsers:t.showAllUsers,showActiveUsers:t.showActiveUsers,showInactiveUsers:t.showInactiveUsers,ariaFilterOptions:t.ariaFilterOptions}}),a("div",{ref:o,"aria-busy":C,children:C?_("div",{className:"loadingContainer",role:"status","aria-live":"polite",children:[a(ee,{testId:"companyUsersTableLoader"}),a("span",{className:"sr-only",children:t.ariaLoadingUsers})]}):a(pe,{columns:y,rowData:A,mobileLayout:"stacked","aria-label":t.ariaUsersTable,summary:t.ariaShowingUsers.replace("{count}",c.length.toString())})}),_("nav",{"aria-label":t.ariaPaginationNav,className:"paginationContainer",children:[a("div",{"aria-live":"polite","aria-atomic":"true",children:t.itemsText.replace("{count}",E.toString())}),v>1&&_("div",{className:"paginationButtons",role:"group","aria-label":t.ariaPageNavigation,children:[a(P,{variant:"secondary",onClick:L,disabled:h===1,"aria-label":t.ariaPreviousPageFull.replace("{current}",h.toString()),children:t.previousPage}),a("span",{"aria-current":"page","aria-live":"polite",children:t.pageInfo.replace("{current}",h.toString()).replace("{total}",v.toString())}),a(P,{variant:"secondary",onClick:e,disabled:h===v,"aria-label":t.ariaNextPageFull.replace("{current}",h.toString()),children:t.nextPage})]}),_("div",{className:"pageSizeSelector",children:[a("label",{htmlFor:"page-size-select",id:"page-size-label",children:a("span",{children:t.showLabel})}),a(Q,{id:"page-size-select",name:"pageSize",value:S.toString(),options:ye,onChange:k,"aria-labelledby":"page-size-label","aria-describedby":"page-size-description"}),a("span",{id:"page-size-description",children:t.perPageLabel})]})]}),b&&a("div",{className:"addUserButtonContainer",children:a(P,{variant:"primary",onClick:()=>w.open(),"aria-label":t.addNewUser,children:t.addNewUser})}),s,w.isOpen&&b&&a(j,{open:w.isOpen,onClose:w.close,size:"medium",children:a(K,{mode:"add",entityId:null,parentStructureId:null,permissions:{canEditUsers:b},onSaved:w.close,onCancel:w.close})}),p.selectedId&&p.isOpen&&b&&a(j,{open:p.isOpen,onClose:p.close,size:"medium",children:a(K,{mode:"edit",entityId:p.selectedId,parentStructureId:null,permissions:{canEditUsers:b},onSaved:p.close,onCancel:p.close})}),d.selectedId&&b&&T&&a(de,{isOpen:d.isOpen,userId:d.selectedId,userStatus:T.status||"ACTIVE",onClose:d.close})]})};export{Le as CompanyUsers,Le as default};
//# sourceMappingURL=CompanyUsers.js.map
