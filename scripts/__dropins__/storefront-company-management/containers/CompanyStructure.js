/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsx as e,jsxs as O,Fragment as he}from"@dropins/tools/preact-jsx-runtime.js";import{Slot as be,classes as ve}from"@dropins/tools/lib.js";import{Checkbox as ge,Card as ie,InLineAlert as ce,ProgressSpinner as de,Field as te,Input as ne,Picker as me,Button as W,Modal as Ce,Header as Se}from"@dropins/tools/components.js";import{useMemo as ue,useRef as oe,useCallback as $,useState as b,useEffect as se}from"@dropins/tools/preact-hooks.js";import{i as Ne,f as Ie,b as Te}from"../chunks/fetchUserPermissions.js";import{useText as re}from"@dropins/tools/i18n.js";import{memo as fe}from"@dropins/tools/preact-compat.js";import{events as le}from"@dropins/tools/event-bus.js";import{g as Ee,c as we,u as _e,i as ke,a as xe,b as Ue,d as Ae,e as Re,f as De,h as Me,j as Pe,k as je}from"../chunks/isCompanyUserEmailAvailable.js";import{C as Ve,a as qe,p as pe,E as ye,u as Le,b as Fe}from"../chunks/useInLineAlert.js";import"../chunks/fetch-error.js";import"@dropins/tools/fetch-graphql.js";const ze=p=>{const S=new Map;for(const u of p){const v=u.parentId??null,t=S.get(v)??[];t.push(u),S.set(v,t)}for(const[,u]of S)u.sort((v,t)=>v.label.localeCompare(t.label));return S},Be=({items:p,rootId:S=null,className:u,expandedIds:v,selectedId:t=null,selectedIds:N,onExpandedChange:s,onSelectedChange:a,onSelectedIdsChange:C,renderNode:c,role:U="tree",draggable:I,canDrop:j,onMove:w,isCheckable:E,checkedIds:V,onCheckedChange:M,renderExpander:R,renderCheckbox:H,renderIcon:q})=>{const G=ue(()=>ze(p),[p]),m=oe(null),d=oe(!1),h=ue(()=>new Map(p.map(i=>[i.id,i])),[p]),B=(i,T)=>{const _=[],F=[T];for(;F.length;){const g=F.pop(),n=i.get(g)??[];for(const o of n)_.push(o.id),F.push(o.id)}return _},Y=$(i=>B(G,i),[G]),K=$(i=>E?E(i):!0,[E]),L=$(i=>{if(!h.get(i))return{checked:!1,indeterminate:!1};const _=[i,...Y(i)].filter(n=>{const o=h.get(n);return o?K(o):!1});if(_.length===0)return{checked:!1,indeterminate:!1};const F=V??new Set,g=_.reduce((n,o)=>F.has(o)?n+1:n,0);return g===0?{checked:!1,indeterminate:!1}:g===_.length?{checked:!0,indeterminate:!1}:{checked:!1,indeterminate:!0}},[h,Y,K,V]),X=$(i=>{if(!M)return;const T=new Set(V??[]),{checked:_}=L(i),F=[i,...Y(i)].filter(g=>{const n=h.get(g);return n?K(n):!1});if(_)for(const g of F)T.delete(g);else for(const g of F)T.add(g);M(T)},[V,M,L,Y,h,K]),Z=$(i=>e(ge,{name:`tree-checkbox-${Math.random().toString(36).substr(2,9)}`,checked:i.checked,indeterminate:i.indeterminate,onChange:i.onCheck}),[]),l=$(i=>{const T=new Set(v);T.has(i)?T.delete(i):T.add(i),s(T)},[v,s]),D=$(i=>{const T=h.get(i);if(T&&K(T)&&M&&X(i),!C){a==null||a(i);return}const _=!!d.current,F=_?new Set(N??[]):new Set;_&&F.has(i)?F.delete(i):F.add(i),C(F),d.current=!1},[a,C,N,h,K,M,X]),A=(i,T)=>{const _=G.get(i)??[];return _.length?e("ul",{role:T===1?U:"group",className:T===1?u??"acm-tree":"acm-tree__group",children:_.map((g,n)=>{const o=(G.get(g.id)??[]).length>0,x=v.has(g.id),r=N?N.has(g.id):t===g.id,y=!!(I!=null&&I(g)),P=k=>j?j(k,g.id):k!==g.id,f=o?()=>R?R({expanded:x,hasChildren:o,toggle:()=>l(g.id)}):null:void 0,z=(()=>{if(!M)return;const k=h.get(g.id);if(!k||!K(k))return;const Q=L(g.id),ee=H||Z;return()=>ee({checked:Q.checked,indeterminate:Q.indeterminate,onCheck:()=>X(g.id)})})(),J=q?()=>q({item:g,level:T,hasChildren:o,expanded:x}):void 0,ae=c({item:g,level:T,expanded:x,selected:!!r,hasChildren:o,toggle:()=>l(g.id),select:()=>D(g.id),...f?{expander:f}:{},...z?{checkbox:z}:{},...J?{icon:J}:{}});return O("li",{role:"treeitem",className:"acm-tree__item","data-level":T,"aria-expanded":o?x:void 0,"aria-selected":r||void 0,"aria-level":T,"aria-setsize":_.length,"aria-posinset":n+1,draggable:y,onMouseDown:k=>{d.current=!!(k.metaKey||k.ctrlKey)},onDragStart:k=>{var Q;if(k.stopPropagation(),!!y){m.current=g.id;try{(Q=k.dataTransfer)==null||Q.setData("text/plain",g.id)}catch{}}},onDragOver:k=>{var ee;k.stopPropagation();const Q=m.current??(((ee=k.dataTransfer)==null?void 0:ee.getData("text/plain"))||"");Q&&P(Q)&&k.preventDefault()},onDrop:k=>{var ee;k.stopPropagation();const Q=m.current??(((ee=k.dataTransfer)==null?void 0:ee.getData("text/plain"))||"");m.current=null,Q&&P(Q)&&(w==null||w({id:Q,newParentId:g.id}))},children:[ae,o&&x?A(g.id,T+1):null]},g.id)})}):null};return e("div",{className:"acm-tree-root",children:A(S,1)})};function Oe(p){const{mode:S,entityId:u,parentStructureId:v,onSaved:t}=p,N=re({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError"}),[s,a]=b({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[C,c]=b({}),[U,I]=b({}),[j,w]=b(!1),[E,V]=b(null),[M,R]=b(null),[H,q]=b(""),[G,m]=b(""),[d,h]=b(!1);se(()=>{S!=="edit"||!u||(w(!0),Ee(u).then(l=>{var A;if(!l)return;const D=l.email||"";a(i=>({...i,firstName:l.firstName||"",lastName:l.lastName||"",email:D,jobTitle:l.jobTitle||"",telephone:l.telephone||"",status:l.status||"ACTIVE"})),m(D),(A=l==null?void 0:l.role)!=null&&A.id&&a(i=>({...i,roleId:l.role.id})),h((l==null?void 0:l.isCompanyAdmin)??!1)}).finally(()=>w(!1)))},[S,u]);const B=l=>/.+@.+\..+/.test(l),Y=(l,D)=>l==="firstName"?D.trim()?null:N.firstNameRequired:l==="lastName"?D.trim()?null:N.lastNameRequired:l==="email"?D.trim()?B(D.trim())?null:N.emailInvalid:N.emailRequired:l==="jobTitle"?D.trim()?null:N.jobTitleRequired:l==="telephone"?D.trim()?null:N.workPhoneRequired:l==="roleId"?D?null:N.selectRole:null,K=(l,D)=>{a(A=>({...A,[l]:D})),C[l]&&c(A=>({...A,[l]:""})),l==="email"&&R(null),E&&V(null)},L=async l=>{I(A=>({...A,[l]:!0}));const D=Y(l,String(s[l]??""));if(D&&c(A=>({...A,[l]:D})),l==="email"){const A=(s.email||"").trim();if(S==="edit"&&A.toLowerCase()===(G||"").trim().toLowerCase()){R(null);return}if(B(A)&&A!==H){const i=await ke(A);q(A),R(i),i===!1&&c(T=>({...T,email:"A user with this email address is already a member of your company."}))}}},X=ue(()=>!!s.roleId&&!!(s.firstName||"").trim()&&!!(s.lastName||"").trim()&&!!(s.jobTitle||"").trim()&&!!(s.telephone||"").trim()&&B((s.email||"").trim())&&!C.email&&M!==!1,[s,C,M]);return{values:s,errors:C,touched:U,loading:j,setValue:K,onBlur:L,canSubmit:X,submit:async()=>{const l=["firstName","lastName","email","jobTitle","telephone","roleId"],D={};for(const _ of l){const F=Y(_,String(s[_]??""));F&&(D[_]=F)}if(c(D),I({firstName:!0,lastName:!0,email:!0,jobTitle:!0,telephone:!0,roleId:!0}),Object.keys(D).length||M===!1)return;const A=`${s.firstName||""} ${s.lastName||""}`.trim()||s.email||"",T=d||Ne({id:s.roleId})?"ACTIVE":s.status;try{if(S==="add"){const _=await we({email:s.email||"",firstName:s.firstName||"",lastName:s.lastName||"",jobTitle:s.jobTitle||"",telephone:s.telephone||"",roleId:s.roleId,status:T,targetId:v??null});if(!_){V(N.createUserError);return}t({label:A,structureId:_.structureId,entityId:_.id,type:"user"})}else u&&(await _e({id:u,email:s.email||"",firstName:s.firstName||"",lastName:s.lastName||"",jobTitle:s.jobTitle||"",telephone:s.telephone||"",status:T,roleId:s.roleId}),t({label:A,entityId:u,type:"user"}))}catch(_){const F=_ instanceof Error?_.message:N.saveUserError;V(F)}},isCompanyAdmin:d,generalError:E}}function $e(){const p=re({loadRolesError:"Company.CompanyStructure.messages.loadRolesError"}),[S,u]=b([]),[v,t]=b(!0),[N,s]=b(null);return se(()=>{let a=!0;return t(!0),xe().then(C=>{a&&u(C)}).catch(()=>{a&&s(p.loadRolesError)}).finally(()=>{a&&t(!1)}),()=>{a=!1}},[p.loadRolesError]),{roles:S,loading:v,error:N}}const He=fe(({mode:p,entityId:S,parentStructureId:u,permissions:v,onSaved:t,onCancel:N})=>{const s=(v==null?void 0:v.canEditUsers)??!1,{roles:a,loading:C}=$e(),{values:c,errors:U,touched:I,loading:j,setValue:w,onBlur:E,canSubmit:V,submit:M,isCompanyAdmin:R,generalError:H}=Oe({mode:p,entityId:S,parentStructureId:u,onSaved:t}),[q,G]=b(!1),m=re({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator"});return O("div",{children:[e("h3",{className:"acm-structure-panel__title",children:p==="add"?m.addUser:m.editUser}),O(ie,{variant:"secondary",className:`company-user-form__card ${q?"is-working":""}`,children:[H?e(ce,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:H}):null,q?e("div",{className:"company-user-form__overlay","aria-live":"polite",children:e(de,{size:"small"})}):null,j||C?e(Ve,{}):O("div",{className:"company-user-form__content",children:[e(te,{label:m.jobTitle,required:!0,className:"acm-structure-panel__field",error:I.jobTitle&&U.jobTitle?U.jobTitle:void 0,children:e(ne,{name:"job_title",type:"text",value:c.jobTitle||"",onValue:d=>w("jobTitle",d),onBlur:()=>E("jobTitle"),variant:"primary",size:"medium"})}),e(te,{label:m.userRole,required:!0,className:"acm-structure-panel__field",error:!R&&I.roleId&&U.roleId?U.roleId:void 0,disabled:R,children:R?e(me,{name:"role",value:"MA==",options:[{value:"MA==",text:m.companyAdministrator}]}):e(me,{name:"role",value:c.roleId||"placeholder",onChange:d=>{var h,B;return w("roleId",String(((h=d==null?void 0:d.target)==null?void 0:h.value)==="placeholder"?"":((B=d==null?void 0:d.target)==null?void 0:B.value)??""))},options:[{value:"placeholder",text:m.selectRole,disabled:!0},...a.map(d=>({value:d.id,text:d.name}))]})}),e(te,{label:m.firstName,required:!0,className:"acm-structure-panel__field",error:I.firstName&&U.firstName?U.firstName:void 0,children:e(ne,{name:"first_name",type:"text",value:c.firstName,onValue:d=>w("firstName",d),onBlur:()=>E("firstName"),variant:"primary",size:"medium"})}),e(te,{label:m.lastName,required:!0,className:"acm-structure-panel__field",error:I.lastName&&U.lastName?U.lastName:void 0,children:e(ne,{name:"last_name",type:"text",value:c.lastName,onValue:d=>w("lastName",d),onBlur:()=>E("lastName"),variant:"primary",size:"medium"})}),e(te,{label:m.email,required:!0,className:"acm-structure-panel__field",error:I.email&&U.email?U.email:void 0,children:e(ne,{name:"email",type:"email",value:c.email,onValue:d=>w("email",d),onBlur:()=>void E("email"),placeholder:"jdoe@example.com",variant:"primary",size:"medium"})}),e(te,{label:m.workPhoneNumber,required:!0,className:"acm-structure-panel__field",error:I.telephone&&U.telephone?U.telephone:void 0,children:e(ne,{name:"telephone",type:"text",value:c.telephone||"",onValue:d=>w("telephone",d),onBlur:()=>E("telephone"),variant:"primary",size:"medium"})}),e(te,{label:m.status,className:"acm-structure-panel__field",disabled:R||!s,children:e(me,{name:"status",value:c.status,onChange:d=>{var h;return w("status",String(((h=d==null?void 0:d.target)==null?void 0:h.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:m.active},{value:"INACTIVE",text:m.inactive}]})})]})]}),j||C?null:O("div",{className:"acm-structure-modal__actions",children:[e(W,{type:"button",variant:"primary",disabled:!V||q,onClick:async()=>{if(!q){G(!0);try{await M()}finally{G(!1)}}},children:"Save"}),e(W,{type:"button",variant:"secondary",disabled:q,onClick:N,children:"Cancel"})]})]})});function Ye(p){const{mode:S,entityId:u,parentStructureId:v,onSaved:t}=p,N=re({teamTitleRequired:"Company.CompanyStructure.shared.validation.teamTitleRequired",createTeamError:"Company.CompanyStructure.messages.createTeamError",saveTeamError:"Company.CompanyStructure.messages.saveTeamError"}),[s,a]=b({title:"",description:""}),[C,c]=b({}),[U,I]=b({}),[j,w]=b(!1),[E,V]=b(null);se(()=>{S!=="edit"||!u||(w(!0),Ue(u).then(m=>{m&&a({title:m.name||"",description:m.description||""})}).finally(()=>w(!1)))},[S,u]);const M=(m,d)=>m==="title"?d.trim()?null:N.teamTitleRequired:null,R=(m,d)=>{a(h=>({...h,[m]:d})),C[m]&&c(h=>({...h,[m]:""})),E&&V(null)},H=m=>{I(h=>({...h,[m]:!0}));const d=M(m,s[m]||"");d&&c(h=>({...h,[m]:d}))},q=ue(()=>!!s.title.trim(),[s.title]);return{values:s,errors:C,touched:U,loading:j,setValue:R,onBlur:H,canSubmit:q,submit:async()=>{const m=M("title",s.title);if(m){c({title:m}),I({title:!0});return}const d=s.title;try{if(S==="add"){const h=await Ae({name:s.title,description:s.description||null,targetId:v??null});if(!h){V(N.createTeamError);return}t({label:d,structureId:h.structureId,entityId:h.id,type:"team",description:s.description})}else u&&(await Re({id:u,name:s.title,description:s.description||null}),t({label:d,entityId:u,type:"team",description:s.description}))}catch(h){const B=h instanceof Error?h.message:N.saveTeamError;V(B)}},generalError:E}}const Ge=fe(({mode:p,entityId:S,parentStructureId:u,permissions:v,onSaved:t,onCancel:N})=>{const s=(v==null?void 0:v.canEditUsers)??!1,{values:a,errors:C,touched:c,loading:U,setValue:I,onBlur:j,canSubmit:w,submit:E,generalError:V}=Ye({mode:p,entityId:S,parentStructureId:u,onSaved:t}),[M,R]=b(!1),H=re({addTeam:"Company.CompanyStructure.shared.titles.addTeam",editTeam:"Company.CompanyStructure.shared.titles.editTeam",teamTitle:"Company.CompanyStructure.shared.fields.teamTitle",description:"Company.CompanyStructure.shared.fields.description"});return O("div",{children:[e("h3",{className:"acm-structure-panel__title",children:p==="add"?H.addTeam:H.editTeam}),O(ie,{variant:"secondary",className:`company-team-form__card ${M?"is-working":""}`,children:[V?e(ce,{className:"company-team-form__notification",type:"error",variant:"secondary",heading:V}):null,M?e("div",{className:"company-team-form__overlay","aria-live":"polite",children:e(de,{size:"small"})}):null,U?e(qe,{}):O("div",{className:"company-team-form__content",children:[e(te,{label:H.teamTitle,required:!0,className:"acm-structure-panel__field",error:c.title&&C.title?C.title:void 0,children:e(ne,{name:"team_title",type:"text",value:a.title,onValue:q=>I("title",q),onBlur:()=>j("title"),variant:"primary",size:"medium",disabled:!s})}),e(te,{label:H.description,className:"acm-structure-panel__field",children:e(ne,{name:"team_description",type:"textarea",value:a.description,onValue:q=>I("description",q),variant:"primary",size:"medium",disabled:!s})})]})]}),U?null:O("div",{className:"acm-structure-modal__actions",children:[e(W,{type:"button",variant:"primary",onClick:async()=>{if(!M){R(!0);try{await E()}finally{R(!1)}}},disabled:!w||M,children:"Save"}),e(W,{type:"button",variant:"secondary",disabled:M,onClick:N,children:"Cancel"})]})]})});function Ke({handleSetInLineAlert:p,permissions:S}={permissions:null}){const u=(S==null?void 0:S.canViewUsers)??!1,v=re({structureSuccess:"Company.CompanyStructure.messages.structureSuccess",structureError:"Company.CompanyStructure.messages.structureError",loadError:"Company.CompanyStructure.messages.loadError",updateError:"Company.CompanyStructure.messages.updateError",failedToMoveItem:"Company.CompanyStructure.messages.failedToMoveItem"}),{structureSuccess:t,structureError:N,loadError:s,updateError:a}=v,[C,c]=b(null),[U,I]=b(!0),[j,w]=b(!1),[E,V]=b(!1),[M,R]=b(new Set),[H,q]=b(null),[G,m]=b(new Set),[d,h]=b({}),B=oe(p),Y=oe(!1),K=oe(!1);se(()=>{B.current=p},[p]);const L=$((n,o)=>{p&&(n==="success"?p({type:"success",text:o??t}):n==="error"?p({type:"error",text:o??N}):p(),w(!1))},[p,t,N]),X=$(async()=>{if(Y.current)return null;if(Y.current=!0,!u)return I(!1),c(null),R(new Set),q(null),m(new Set),Y.current=!1,null;I(!0);try{const o=await De();return c(o),R(new Set(o.map(x=>x.id))),I(!1),o}catch{return I(!1),B.current&&B.current({type:"error",text:s}),null}finally{Y.current=!1}},[u,s]);se(()=>{u&&!K.current&&(K.current=!0,X())},[u,X]),se(()=>{const n=()=>{I(!0),R(new Set),q(null),m(new Set),X()},o=le.on("companyContext/changed",n,{eager:!0});return()=>{o==null||o.off()}},[X]);const Z=$(async(n,o)=>{try{return w(!0),await Me({id:n,parentId:o})?(c(r=>r?r.map(y=>y.id===n?{...y,parentId:o}:y):null),R(r=>new Set([...r,o])),pe(ye.EDIT_COMPANY_STRUCTURE_EVENT,{action:"move",nodeId:n,newParentId:o}),le.emit("companyStructure/updated",{message:"Structure updated",action:"move",nodeId:n,newParentId:o,nodes:C||[]}),L("success"),!0):(L("error",v.failedToMoveItem),!1)}catch(x){const r=x instanceof Error?x.message:a;return L("error",r),!1}finally{w(!1)}},[C,L,a,v.failedToMoveItem]),l=$(()=>{C&&R(new Set(C.map(n=>n.id)))},[C]),D=$(()=>{if(C){const n=C.filter(o=>o.parentId===null).map(o=>o.id);R(new Set(n))}},[C]),A=$(n=>{c(o=>{const x=o?[...o,{id:n.id,parentId:n.parentId,label:n.label,type:n.type,entityId:n.entityId,description:n.description}]:[{id:n.id,parentId:n.parentId,label:n.label,type:n.type,entityId:n.entityId,description:n.description}];return le.emit("companyStructure/updated",{message:"Structure updated",action:"add",nodeId:n.id,newParentId:n.parentId||void 0,nodes:x}),pe(ye.EDIT_COMPANY_STRUCTURE_EVENT,{action:"add",nodeId:n.id,newParentId:n.parentId||void 0,nodeType:n.type}),x}),n.parentId&&R(o=>new Set([...o,n.parentId]))},[]),i=$((n,o,x)=>{o&&c(r=>r?r.map(y=>n.includes(y.id)?{...y,label:o,description:x}:y):null)},[]),T=$(async n=>{if(n.length)try{w(!0);const o=new Map((C||[]).map(x=>[x.id,x]));for(const x of n){const r=o.get(x);!r||!r.entityId||(r.type==="team"?await Pe(r.entityId):await je(r.entityId))}c(x=>{if(!x)return null;const r=new Set(n);return x.filter(y=>!r.has(y.id))}),q(null),m(new Set),pe(ye.EDIT_COMPANY_STRUCTURE_EVENT,{action:"remove",nodeIds:n}),le.emit("companyStructure/updated",{message:"Structure updated",action:"remove",nodeIds:n,nodes:C||[]}),L("success")}catch(o){const x=o instanceof Error?o.message:a;L("error",x)}finally{w(!1)}},[C,L,a]),_=$(n=>{h(n)},[]),F=$(()=>{V(!0),L("success",""),h({})},[L]),g=$(n=>{n==null||n(),V(!1),h({})},[]);return{nodes:C,loading:U,submitLoading:j,showEditForm:E,inputChange:d,expanded:M,setExpanded:R,selected:H,setSelected:q,selectedMany:G,setSelectedMany:m,move:Z,expandAll:l,collapseAll:D,insertNode:A,renameNodes:i,removeNodes:T,handleInputChange:_,handleShowEditForm:F,handleHideEditForm:g,renderAlertMessage:L,working:j}}const Je=fe(({permissions:p,slots:S})=>{var x;const u=(p==null?void 0:p.canEditUsers)??!1,v=(p==null?void 0:p.canViewUsers)??!1,t=re({expandAll:"Company.CompanyStructure.shared.buttons.expandAll",collapseAll:"Company.CompanyStructure.shared.buttons.collapseAll",addUser:"Company.CompanyStructure.shared.buttons.addUser",addTeam:"Company.CompanyStructure.shared.buttons.addTeam",editSelected:"Company.CompanyStructure.shared.buttons.editSelected",remove:"Company.CompanyStructure.shared.buttons.remove",ok:"Company.CompanyStructure.shared.buttons.ok",cancel:"Company.CompanyStructure.shared.buttons.cancel",close:"Company.CompanyStructure.shared.buttons.close",deleting:"Company.CompanyStructure.shared.buttons.deleting",removing:"Company.CompanyStructure.shared.buttons.removing",noStructureData:"Company.CompanyStructure.messages.noStructureData",processing:"Company.CompanyStructure.shared.messages.processing",cannotDeleteUser:"Company.CompanyStructure.messages.cannotDeleteUser",cannotDeleteTeam:"Company.CompanyStructure.messages.cannotDeleteTeam",removeUserConfirm:"Company.CompanyStructure.messages.removeUserConfirm",deleteTeamConfirm:"Company.CompanyStructure.messages.deleteTeamConfirm",removeItemsConfirm:"Company.CompanyStructure.messages.removeItemsConfirm",teamDescription:"Company.CompanyStructure.shared.messages.teamDescription",removeUserMessage:"Company.CompanyStructure.messages.removeUserMessage",cannotDeleteUserMessage:"Company.CompanyStructure.messages.cannotDeleteUserMessage",cannotDeleteTeamMessage:"Company.CompanyStructure.messages.cannotDeleteTeamMessage",removeItemsMessage:"Company.CompanyStructure.messages.removeItemsMessage",companyStructureActions:"Company.CompanyStructure.shared.ariaLabels.companyStructureActions",expandAllNodes:"Company.CompanyStructure.shared.ariaLabels.expandAllNodes",collapseAllNodes:"Company.CompanyStructure.shared.ariaLabels.collapseAllNodes",addUserAria:"Company.CompanyStructure.shared.ariaLabels.addUser",addTeamAria:"Company.CompanyStructure.shared.ariaLabels.addTeam",editSelectedAria:"Company.CompanyStructure.shared.ariaLabels.editSelected",removeSelectedAria:"Company.CompanyStructure.shared.ariaLabels.removeSelected",showDescription:"Company.CompanyStructure.shared.ariaLabels.showDescription",delete:"Company.CompanyStructure.shared.options.delete",expand:"Company.CompanyStructure.shared.options.expand",collapse:"Company.CompanyStructure.shared.options.collapse",deleteTeamMessage:"Company.CompanyStructure.messages.deleteTeamMessage"}),{inLineAlertProps:N,handleSetInLineAlert:s}=Le(),{nodes:a,loading:C,submitLoading:c,expanded:U,setExpanded:I,selected:j,setSelected:w,selectedMany:E,setSelectedMany:V,move:M,expandAll:R,collapseAll:H,insertNode:q,renameNodes:G,removeNodes:m}=Ke({handleSetInLineAlert:s,permissions:p}),[d,h]=b(null),[B,Y]=b("add"),[K,L]=b(!1),[X,Z]=b([]),[l,D]=b({title:"",body:"",confirmLabel:t.remove,blocked:!1}),[A,i]=b(null),T=()=>h(null),_=((x=a==null?void 0:a.find(r=>r.parentId===null))==null?void 0:x.id)??null,F=(a||[]).map(r=>({id:r.id,parentId:r.parentId,label:r.label})),g=(r,y)=>{let P=r;const f=new Map(F.map(J=>[J.id,J])),z=new Set;for(;P&&!z.has(P);){z.add(P);const J=f.get(P);if(!J)break;if(J.parentId===y)return!0;P=J.parentId??null}return!1},n=(a||[]).map(r=>({id:r.id,parentId:r.parentId,label:r.label,type:r.type,description:r.description,entityId:r.entityId})),o=O(he,{children:[(()=>{const r=E!=null&&E.size?Array.from(E):j?[j]:[],y=u&&r.length===1,P=u&&r.length>=1;return e(ie,{variant:"secondary",className:"acm-structure-toolbar-card acm-structure-toolbar-card--spaced",children:O("div",{className:"acm-structure-toolbar",role:"toolbar","aria-label":t.companyStructureActions,children:[e(W,{type:"button",variant:"secondary",onClick:R,"aria-label":t.expandAllNodes,disabled:!v,"aria-disabled":!v,children:t.expandAll}),e(W,{type:"button",variant:"secondary",onClick:H,"aria-label":t.collapseAllNodes,disabled:!v,"aria-disabled":!v,children:t.collapseAll}),e(W,{type:"button",variant:"primary",onClick:()=>{Y("add"),h("user")},"aria-label":t.addUserAria,disabled:!u,"aria-disabled":!u,children:t.addUser}),e(W,{type:"button",variant:"primary",onClick:()=>{Y("add"),h("team")},"aria-label":t.addTeamAria,disabled:!u,"aria-disabled":!u,children:t.addTeam}),e(W,{type:"button",variant:"primary",disabled:!y,"aria-disabled":!y,"aria-label":t.editSelectedAria,onClick:()=>{if(!y)return;const f=r,z=a==null?void 0:a.find(J=>J.id===f[0]);(z==null?void 0:z.type)==="user"?(Y("edit"),h("user")):(Y("edit"),h("team"))},children:t.editSelected}),e(W,{type:"button",variant:"secondary",disabled:!P||c,"aria-disabled":!P||c,"aria-label":t.removeSelectedAria,onClick:()=>{if(!P||c)return;const f=r;if(f.length===1){const z=a==null?void 0:a.find(ae=>ae.id===f[0]);if(!z)return;(a==null?void 0:a.some(ae=>ae.parentId===z.id))?(D({title:z.type==="user"?t.cannotDeleteUser:t.cannotDeleteTeam,body:z.type==="user"?t.cannotDeleteUserMessage:t.cannotDeleteTeamMessage,confirmLabel:void 0,blocked:!0}),Z([]),L(!0)):(D({title:z.type==="user"?t.removeUserConfirm:t.deleteTeamConfirm,body:z.type==="user"?t.removeUserMessage:t.deleteTeamMessage,confirmLabel:z.type==="user"?t.remove:t.delete,blocked:!1}),Z(f),L(!0))}else D({title:t.removeItemsConfirm,body:t.removeItemsMessage,confirmLabel:t.remove,blocked:!1}),Z(f),L(!0)},children:t.remove})]})})})(),d?O("div",{className:"acm-structure-panel",children:[c?O("div",{className:"acm-structure-working","aria-live":"polite",children:[e(de,{size:"small"})," ",t.processing]}):null,d==="user"?(()=>{const r=E!=null&&E.size?Array.from(E):j?[j]:[],y=r.length?a==null?void 0:a.find(f=>f.id===r[0]):void 0,P=(y==null?void 0:y.id)??_;return e(He,{mode:B,entityId:y==null?void 0:y.entityId,parentStructureId:P,permissions:p,onSaved:f=>{B==="add"?f.structureId&&(q({id:f.structureId,parentId:P,label:f.label,type:f.type,entityId:f.entityId}),f.structureId&&(w(f.structureId),V(new Set([f.structureId])))):r.length&&G(r,f.label),T()},onCancel:T})})():null,d==="team"?(()=>{const r=E!=null&&E.size?Array.from(E):j?[j]:[],y=r.length?a==null?void 0:a.find(f=>f.id===r[0]):void 0,P=(y==null?void 0:y.id)??_;return e(Ge,{mode:B,entityId:y==null?void 0:y.entityId,parentStructureId:P,permissions:p,onSaved:f=>{B==="add"?f.structureId&&(q({id:f.structureId,parentId:P,label:f.label,type:f.type,entityId:f.entityId,description:f.description}),f.structureId&&(w(f.structureId),V(new Set([f.structureId])))):r.length&&G(r,f.label,f.description),T()},onCancel:T})})():null]}):null,O(ie,{variant:"secondary",className:`acm-structure-tree-card ${c?"is-working":""}`,children:[N&&N.text?e(ce,{className:"acm-structure-panel__notification",type:N.type||"success",variant:"secondary",heading:N.text}):null,!C&&!c&&a&&a.length===0?e(ce,{className:"acm-structure-panel__notification",type:"warning",variant:"secondary",heading:t.noStructureData}):null,!C&&c?e("div",{className:"acm-structure-tree-overlay","aria-live":"polite",children:e(de,{size:"medium"})}):null,C?e("div",{className:"acm-structure-tree-content",children:e(Fe,{rows:8})}):e("div",{className:"acm-structure-tree-content",children:e(Be,{rootId:null,items:F,expandedIds:U,selectedId:j,selectedIds:E,onExpandedChange:I,onSelectedChange:w,onSelectedIdsChange:V,renderExpander:({expanded:r,toggle:y})=>e("button",{type:"button",className:`acm-structure-expander acm-structure-expander-button ${r?"is-open":""}`,"aria-label":r?t.collapse:t.expand,onClick:P=>{P.stopPropagation(),y()},children:r?"−":"+"}),renderNode:({item:r,hasChildren:y,select:P,expander:f,checkbox:z,icon:J})=>{var ae;return O("div",{className:"acm-structure-row",onClick:P,children:[y?f?e("span",{onClick:k=>k.stopPropagation(),children:f()}):e("span",{className:"acm-structure-expander acm-structure-expander--placeholder"}):e("span",{className:"acm-structure-expander acm-structure-expander--placeholder"}),e("span",{className:"acm-structure-handle","aria-hidden":!0}),J?e("span",{onClick:k=>k.stopPropagation(),children:J()}):e("span",{className:`acm-structure-icon ${((ae=a==null?void 0:a.find(k=>k.id===r.id))==null?void 0:ae.type)==="team"?"is-team":"is-user"}`,"aria-hidden":!0}),z?e("span",{onClick:k=>k.stopPropagation(),children:z()}):null,e("span",{className:"acm-structure-label",children:r.label}),(()=>{const k=a==null?void 0:a.find(ee=>ee.id===r.id),Q=(k==null?void 0:k.type)==="team"&&k.description||"";return Q?e(W,{type:"button",variant:"secondary",onClick:ee=>{ee.stopPropagation(),i({id:r.id,text:Q})},"aria-label":t.showDescription,className:"acm-structure-description-button",children:"?"}):null})()]})},draggable:()=>!c&&u,canDrop:(r,y)=>{if(!u||r===y)return!1;const P=a==null?void 0:a.find(f=>f.id===r);return P&&P.parentId===y?!1:!g(y,r)},onMove:async({id:r,newParentId:y})=>{u&&await M(r,y)}})})]}),K?e(Ce,{open:K,onClose:()=>{c||(L(!1),Z([]))},children:O("div",{className:"acm-structure-modal-content",children:[e("h3",{className:"acm-structure-modal-title",children:l.title}),e("div",{children:l.body}),e("div",{className:"acm-structure-modal-actions",children:l.blocked?e(W,{type:"button",variant:"secondary",disabled:c,onClick:()=>{c||(L(!1),Z([]))},children:t.ok}):O(he,{children:[e(W,{type:"button",variant:"secondary",disabled:c,onClick:()=>{c||(L(!1),Z([]))},children:t.cancel}),e(W,{type:"button",variant:"primary",disabled:c,onClick:async()=>{await m(X),L(!1),Z([])},children:c?l.confirmLabel===t.delete?t.deleting:t.removing:l.confirmLabel||t.remove})]})})]})}):null,A?e(Ce,{open:!!A,onClose:()=>i(null),children:O("div",{className:"acm-structure-modal-content",children:[e("h3",{className:"acm-structure-modal-title",children:t.teamDescription}),e("div",{children:A.text}),e("div",{className:"acm-structure-modal-actions",children:e(W,{type:"button",variant:"secondary",onClick:()=>i(null),children:t.close})})]})}):null]});return S!=null&&S.StructureData?e(be,{name:"StructureData",slot:S.StructureData,context:{structureData:n,Default:o}}):o}),Qe=()=>{const p=re({fetchPermissionsError:"Company.CompanyStructure.messages.fetchPermissionsError"}),[S,u]=b(null),[v,t]=b(!0),[N,s]=b(null);return se(()=>{let a=!0;return(async()=>{var c,U;try{t(!0),s(null);const{roleResponse:I}=await Ie();if(!a)return;const j=(U=(c=I==null?void 0:I.data)==null?void 0:c.customer)==null?void 0:U.role,w=Te(j);u(w)}catch(I){if(!a)return;s(I instanceof Error?I:new Error(p.fetchPermissionsError))}finally{a&&t(!1)}})(),()=>{a=!1}},[p.fetchPermissionsError]),{permissions:S,loading:v,error:N}},ct=({className:p,withHeader:S=!1,slots:u})=>{const v=re({containerTitle:"Company.CompanyStructure.containerTitle"}),{permissions:t}=Qe();return O("div",{className:ve(["account-company-structure",p]),children:[S?e(Se,{title:v.containerTitle,divider:!1,className:"company-structure__title"}):null,e(Je,{slots:u,permissions:t})]})};export{ct as CompanyStructure};
//# sourceMappingURL=CompanyStructure.js.map
