/*! Copyright 2025 Adobe
All Rights Reserved. */
import{jsxs as B,jsx as t}from"@dropins/tools/preact-jsx-runtime.js";import{memo as D}from"@dropins/tools/preact-compat.js";import{useState as m,useEffect as M,useMemo as H}from"@dropins/tools/preact-hooks.js";import{Card as J,InLineAlert as K,ProgressSpinner as Q,Field as T,Input as A,Picker as P,Button as F}from"@dropins/tools/components.js";import{C as W}from"./useInLineAlert.js";import{i as X}from"./company-permissions.js";import{g as Y,c as Z,u as ee,i as ae,a as re}from"./updateCompanyUser.js";import{useText as L}from"@dropins/tools/i18n.js";function te(b){const{mode:C,entityId:d,parentStructureId:S,onSaved:g}=b,n=L({firstNameRequired:"Company.CompanyStructure.shared.validation.firstNameRequired",lastNameRequired:"Company.CompanyStructure.shared.validation.lastNameRequired",emailRequired:"Company.CompanyStructure.shared.validation.emailRequired",emailInvalid:"Company.CompanyStructure.shared.validation.emailInvalid",jobTitleRequired:"Company.CompanyStructure.shared.validation.jobTitleRequired",workPhoneRequired:"Company.CompanyStructure.shared.validation.workPhoneRequired",selectRole:"Company.CompanyStructure.shared.validation.selectRole",createUserError:"Company.CompanyStructure.messages.createUserError",saveUserError:"Company.CompanyStructure.messages.saveUserError"}),[a,c]=m({firstName:"",lastName:"",email:"",jobTitle:"",telephone:"",roleId:"",status:"ACTIVE"}),[f,u]=m({}),[s,h]=m({}),[U,p]=m(!1),[v,j]=m(null),[q,N]=m(null),[x,I]=m(""),[V,i]=m(""),[r,E]=m(!1);M(()=>{C!=="edit"||!d||(p(!0),Y(d).then(e=>{var o;if(!e)return;const l=e.email||"";c(R=>({...R,firstName:e.firstName||"",lastName:e.lastName||"",email:l,jobTitle:e.jobTitle||"",telephone:e.telephone||"",status:e.status||"ACTIVE"})),i(l),(o=e==null?void 0:e.role)!=null&&o.id&&c(R=>({...R,roleId:e.role.id})),E((e==null?void 0:e.isCompanyAdmin)??!1)}).finally(()=>p(!1)))},[C,d]);const _=e=>/.+@.+\..+/.test(e),z=(e,l)=>e==="firstName"?l.trim()?null:n.firstNameRequired:e==="lastName"?l.trim()?null:n.lastNameRequired:e==="email"?l.trim()?_(l.trim())?null:n.emailInvalid:n.emailRequired:e==="jobTitle"?l.trim()?null:n.jobTitleRequired:e==="telephone"?l.trim()?null:n.workPhoneRequired:e==="roleId"?l?null:n.selectRole:null,$=(e,l)=>{c(o=>({...o,[e]:l})),f[e]&&u(o=>({...o,[e]:""})),e==="email"&&N(null),v&&j(null)},O=async e=>{h(o=>({...o,[e]:!0}));const l=z(e,String(a[e]??""));if(l&&u(o=>({...o,[e]:l})),e==="email"){const o=(a.email||"").trim();if(C==="edit"&&o.toLowerCase()===(V||"").trim().toLowerCase()){N(null);return}if(_(o)&&o!==x){const R=await ae(o);I(o),N(R),R===!1&&u(w=>({...w,email:"A user with this email address is already a member of your company."}))}}},G=H(()=>!!a.roleId&&!!(a.firstName||"").trim()&&!!(a.lastName||"").trim()&&!!(a.jobTitle||"").trim()&&!!(a.telephone||"").trim()&&_((a.email||"").trim())&&!f.email&&q!==!1,[a,f,q]);return{values:a,errors:f,touched:s,loading:U,setValue:$,onBlur:O,canSubmit:G,submit:async()=>{const e=["firstName","lastName","email","jobTitle","telephone","roleId"],l={};for(const y of e){const k=z(y,String(a[y]??""));k&&(l[y]=k)}if(u(l),h({firstName:!0,lastName:!0,email:!0,jobTitle:!0,telephone:!0,roleId:!0}),Object.keys(l).length||q===!1)return;const o=`${a.firstName||""} ${a.lastName||""}`.trim()||a.email||"",w=r||X({id:a.roleId})?"ACTIVE":a.status;try{if(C==="add"){const y=await Z({email:a.email||"",firstName:a.firstName||"",lastName:a.lastName||"",jobTitle:a.jobTitle||"",telephone:a.telephone||"",roleId:a.roleId,status:w,targetId:S??null});if(!y){j(n.createUserError);return}g({label:o,structureId:y.structureId,entityId:y.id,type:"user"})}else d&&(await ee({id:d,email:a.email||"",firstName:a.firstName||"",lastName:a.lastName||"",jobTitle:a.jobTitle||"",telephone:a.telephone||"",status:w,roleId:a.roleId}),g({label:o,entityId:d,type:"user"}))}catch(y){const k=y instanceof Error?y.message:n.saveUserError;j(k)}},isCompanyAdmin:r,generalError:v}}function le(){const b=L({loadRolesError:"Company.CompanyStructure.messages.loadRolesError"}),[C,d]=m([]),[S,g]=m(!0),[n,a]=m(null);return M(()=>{let c=!0;return g(!0),re().then(f=>{c&&d(f)}).catch(()=>{c&&a(b.loadRolesError)}).finally(()=>{c&&g(!1)}),()=>{c=!1}},[b.loadRolesError]),{roles:C,loading:S,error:n}}const ye=D(({mode:b,entityId:C,parentStructureId:d,permissions:S,onSaved:g,onCancel:n})=>{const a=(S==null?void 0:S.canEditUsers)??!1,{roles:c,loading:f}=le(),{values:u,errors:s,touched:h,loading:U,setValue:p,onBlur:v,canSubmit:j,submit:q,isCompanyAdmin:N,generalError:x}=te({mode:b,entityId:C,parentStructureId:d,onSaved:g}),[I,V]=m(!1),i=L({addUser:"Company.CompanyStructure.shared.titles.addUser",editUser:"Company.CompanyStructure.shared.titles.editUser",jobTitle:"Company.CompanyStructure.shared.fields.jobTitle",userRole:"Company.CompanyStructure.shared.fields.userRole",firstName:"Company.CompanyStructure.shared.fields.firstName",lastName:"Company.CompanyStructure.shared.fields.lastName",email:"Company.CompanyStructure.shared.fields.email",workPhoneNumber:"Company.CompanyStructure.shared.fields.workPhoneNumber",status:"Company.CompanyStructure.shared.fields.status",selectRole:"Company.CompanyStructure.shared.options.selectRole",active:"Company.CompanyStructure.shared.options.active",inactive:"Company.CompanyStructure.shared.options.inactive",companyAdministrator:"Company.CompanyStructure.shared.options.companyAdministrator",save:"Company.CompanyStructure.shared.buttons.save",cancel:"Company.CompanyStructure.shared.buttons.cancel"});return B("div",{children:[t("h3",{className:"acm-structure-panel__title",children:b==="add"?i.addUser:i.editUser}),B(J,{variant:"secondary",className:`company-user-form__card ${I?"is-working":""}`,children:[x?t(K,{className:"company-user-form__notification",type:"error",variant:"secondary",heading:x}):null,I?t("div",{className:"company-user-form__overlay","aria-live":"polite",children:t(Q,{size:"small"})}):null,U||f?t(W,{}):B("div",{className:"company-user-form__content",children:[t(T,{label:i.jobTitle,required:!0,className:"acm-structure-panel__field",error:h.jobTitle&&s.jobTitle?s.jobTitle:void 0,children:t(A,{name:"job_title",type:"text",value:u.jobTitle||"",onValue:r=>p("jobTitle",r),onBlur:()=>v("jobTitle"),variant:"primary",size:"medium"})}),t(T,{label:i.userRole,required:!0,className:"acm-structure-panel__field",error:!N&&h.roleId&&s.roleId?s.roleId:void 0,disabled:N,children:N?t(P,{name:"role",value:"MA==",options:[{value:"MA==",text:i.companyAdministrator}]}):t(P,{name:"role",value:u.roleId||"placeholder",onChange:r=>{var E,_;return p("roleId",String(((E=r==null?void 0:r.target)==null?void 0:E.value)==="placeholder"?"":((_=r==null?void 0:r.target)==null?void 0:_.value)??""))},options:[{value:"placeholder",text:i.selectRole,disabled:!0},...c.map(r=>({value:r.id,text:r.name}))]})}),t(T,{label:i.firstName,required:!0,className:"acm-structure-panel__field",error:h.firstName&&s.firstName?s.firstName:void 0,children:t(A,{name:"first_name",type:"text",value:u.firstName,onValue:r=>p("firstName",r),onBlur:()=>v("firstName"),variant:"primary",size:"medium"})}),t(T,{label:i.lastName,required:!0,className:"acm-structure-panel__field",error:h.lastName&&s.lastName?s.lastName:void 0,children:t(A,{name:"last_name",type:"text",value:u.lastName,onValue:r=>p("lastName",r),onBlur:()=>v("lastName"),variant:"primary",size:"medium"})}),t(T,{label:i.email,required:!0,className:"acm-structure-panel__field",error:h.email&&s.email?s.email:void 0,children:t(A,{name:"email",type:"email",value:u.email,onValue:r=>p("email",r),onBlur:()=>void v("email"),placeholder:"jdoe@example.com",variant:"primary",size:"medium"})}),t(T,{label:i.workPhoneNumber,required:!0,className:"acm-structure-panel__field",error:h.telephone&&s.telephone?s.telephone:void 0,children:t(A,{name:"telephone",type:"text",value:u.telephone||"",onValue:r=>p("telephone",r),onBlur:()=>v("telephone"),variant:"primary",size:"medium"})}),t(T,{label:i.status,className:"acm-structure-panel__field",disabled:N||!a,children:t(P,{name:"status",value:u.status,onChange:r=>{var E;return p("status",String(((E=r==null?void 0:r.target)==null?void 0:E.value)??"ACTIVE"))},options:[{value:"ACTIVE",text:i.active},{value:"INACTIVE",text:i.inactive}]})})]})]}),U||f?null:B("div",{className:"acm-structure-modal__actions",children:[t(F,{type:"button",variant:"primary",disabled:!j||I,onClick:async()=>{if(!I){V(!0);try{await q()}finally{V(!1)}}},children:i.save}),t(F,{type:"button",variant:"secondary",disabled:I,onClick:n,children:i.cancel})]})]})});export{ye as C};
//# sourceMappingURL=CompanyUserForm.js.map
