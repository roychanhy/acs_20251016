{"version":3,"file":"BillToShippingAddress.js","sources":["/@dropins/storefront-checkout/src/components/BillToShippingAddress/BillToShippingAddressSkeleton.tsx","/@dropins/storefront-checkout/src/components/BillToShippingAddress/BillToShippingAddress.tsx","/@dropins/storefront-checkout/src/containers/BillToShippingAddress/BillToShippingAddress.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Skeleton, SkeletonRow } from '@adobe-commerce/elsie/components';\nimport { FunctionComponent } from 'preact';\n\nexport const BillToShippingAddressSkeleton: FunctionComponent = () => {\n  return (\n    <Skeleton\n      className=\"bill-to-shipping-address__skeleton\"\n      data-testid=\"bill-to-shipping-skeleton\"\n    >\n      <SkeletonRow size=\"small\" variant=\"row\" />\n    </Skeleton>\n  );\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport '@/checkout/components/BillToShippingAddress/BillToShippingAddress.css';\nimport { BillToShippingAddressSkeleton } from '@/checkout/components/BillToShippingAddress/BillToShippingAddressSkeleton';\nimport { WithConditionals } from '@/checkout/components/ConditionalWrapper/ConditionalWrapper';\nimport { Checkbox, InLineAlert } from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { classes } from '@adobe-commerce/elsie/lib/classes';\nimport { FunctionComponent } from 'preact';\nimport { ChangeEvent, HTMLAttributes } from 'preact/compat';\n\nexport interface BillToShippingAddressProps\n  extends Omit<\n    HTMLAttributes<HTMLInputElement>,\n    'loading' | 'disabled' | 'onChange'\n  > {\n  disabled?: boolean;\n  error?: string | null;\n  onChange?: (checked: boolean) => void;\n  onDismissError?: () => void;\n}\n\nconst BillToShippingAddressComponent: FunctionComponent<\n  BillToShippingAddressProps\n> = ({\n  className,\n  checked,\n  disabled,\n  error = null,\n  onChange = () => {},\n  onDismissError = () => {},\n}) => {\n  const translations = useText({\n    title: 'Checkout.BillToShippingAddress.title',\n  });\n\n  const hasError = error !== null;\n\n  const handleChange = (event: Event | ChangeEvent<HTMLInputElement>) => {\n    const checkbox = event.target as HTMLInputElement;\n    onChange?.(checkbox.checked);\n  };\n\n  return (\n    <div className=\"checkout-bill-to-shipping-address\">\n      <Checkbox\n        checked={checked}\n        className={classes([\n          'checkout-bill-to-shipping-address__checkbox',\n          className,\n        ])}\n        data-testid=\"bill-to-shipping-checkbox\"\n        disabled={disabled}\n        label={translations.title}\n        name=\"checkout-bill-to-shipping-address__checkbox\"\n        onChange={handleChange}\n      />\n\n      {hasError && (\n        <div\n          className=\"checkout-bill-to-shipping-address__error\"\n          data-testid=\"checkout-bill-to-shipping-address-alert\"\n        >\n          <InLineAlert\n            heading={error}\n            type=\"error\"\n            variant=\"primary\"\n            onDismiss={onDismissError}\n          />\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport const BillToShippingAddress = WithConditionals(\n  BillToShippingAddressComponent,\n  BillToShippingAddressSkeleton\n);\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { setBillingAddress } from '@/checkout/api';\nimport { BillToShippingAddress as BillToShippingAddressComponent } from '@/checkout/components/BillToShippingAddress';\nimport { Cart } from '@/checkout/data/models/cart';\nimport {\n  getLatestCheckoutUpdate,\n  getValue,\n  hasPendingCartUpdates,\n  hasShippingAddress,\n  notifyValues,\n} from '@/checkout/lib';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { Container } from '@adobe-commerce/elsie/lib';\nimport { events } from '@adobe-commerce/event-bus';\nimport { HTMLAttributes } from 'preact/compat';\nimport { useCallback, useEffect, useRef, useState } from 'preact/hooks';\n\ninterface CartSyncError {\n  error: Error;\n}\n\nexport interface BillToShippingAddressProps\n  extends Omit<HTMLAttributes<HTMLDivElement>, 'onChange'> {\n  active?: boolean;\n  autoSync?: boolean;\n  onCartSyncError?: (error: CartSyncError) => void;\n  onChange?: (checked: boolean) => void;\n}\n\nfunction isBillToShippingAddress(cart: Cart) {\n  const shippingAddress = cart.shippingAddresses?.[0];\n  const hasBillingAddress = !!cart.billingAddress;\n  const sameAsBilling = shippingAddress?.sameAsBilling;\n  return sameAsBilling ?? !hasBillingAddress;\n}\n\nexport const BillToShippingAddress: Container<BillToShippingAddressProps> = ({\n  active = true,\n  autoSync = true,\n  onCartSyncError,\n  onChange,\n}) => {\n  const [error, setError] = useState<string | null>(null);\n  const [isInitialized, setIsInitialized] = useState(false);\n  const [isVirtual, setIsVirtual] = useState(false);\n  const [isChecked, setIsChecked] = useState(true);\n\n  const hasInitialCartData = useRef(false);\n\n  const hasPendingUpdates = hasPendingCartUpdates.value;\n\n  const { cartSyncError } = useText({\n    cartSyncError: 'Checkout.BillToShippingAddress.cartSyncError',\n  });\n\n  const handleDismissError = useCallback(() => {\n    setError(null);\n  }, []);\n\n  const setBillToShipping = useCallback(\n    (value: boolean) => {\n      setError(null);\n      setIsChecked(value);\n      notifyValues({ isBillToShipping: value });\n    },\n    []\n  );\n\n  const handleChange = useCallback(\n    (checked: boolean) => {\n      const isBillToShipping = checked;\n\n      setBillToShipping(isBillToShipping);\n\n      onChange?.(isBillToShipping);\n\n      if (!autoSync || !isBillToShipping || !hasShippingAddress()) {\n        return;\n      }\n\n      setBillingAddress({ sameAsShipping: true }).catch((error: any) => {\n        setBillToShipping(false);\n        onCartSyncError?.({ error });\n\n        if (!onCartSyncError) {\n          setError(cartSyncError);\n        }\n      });\n    },\n    [autoSync, cartSyncError, onCartSyncError, onChange, setBillToShipping]\n  );\n\n  const handleCheckoutData = useCallback(\n    (data: Cart | null) => {\n      const isEmptyCart = !data || data?.isEmpty;\n      const isVirtualCart = Boolean(data?.isVirtual);\n\n      if (isEmptyCart || isVirtualCart) {\n        setIsVirtual(isVirtualCart);\n        setBillToShipping(false);\n        hasInitialCartData.current = false;\n        return;\n      }\n\n      if (!hasInitialCartData.current) {\n        const billToShippingValue = isBillToShippingAddress(data);\n        setBillToShipping(billToShippingValue);\n        hasInitialCartData.current = true;\n      }\n    },\n    [setBillToShipping]\n  );\n\n  useEffect(() => {\n    if (!active) return;\n\n    const pastUpdate = getLatestCheckoutUpdate();\n\n    if (pastUpdate) {\n      setIsInitialized(true);\n      // When component becomes active, restore key state so handleCheckoutData can work properly\n      const userBillToShipping = getValue('isBillToShipping');\n      if (userBillToShipping != null) {\n        setIsChecked(userBillToShipping);\n      }\n      handleCheckoutData(pastUpdate);\n      return;\n    }\n\n    const onCheckoutInit = events.on(\n      'checkout/initialized',\n      (data) => {\n        setIsInitialized(true);\n        handleCheckoutData(data);\n      },\n      { eager: true }\n    );\n\n    return () => {\n      onCheckoutInit?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const onCheckoutUpdated = events.on(\n      'checkout/updated',\n      handleCheckoutData,\n      {\n        eager: false,\n      }\n    );\n\n    return () => {\n      onCheckoutUpdated?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  return (\n    <BillToShippingAddressComponent\n      checked={isChecked}\n      disabled={hasPendingUpdates}\n      error={error}\n      initialized={isInitialized}\n      visible={active && !isVirtual}\n      onChange={handleChange}\n      onDismissError={handleDismissError}\n    />\n  );\n};\n"],"names":["BillToShippingAddressSkeleton","jsx","Skeleton","SkeletonRow","BillToShippingAddressComponent","className","checked","disabled","error","onChange","onDismissError","translations","useText","hasError","handleChange","event","checkbox","jsxs","Checkbox","classes","InLineAlert","BillToShippingAddress","WithConditionals","isBillToShippingAddress","cart","shippingAddress","_a","hasBillingAddress","active","autoSync","onCartSyncError","setError","useState","isInitialized","setIsInitialized","isVirtual","setIsVirtual","isChecked","setIsChecked","hasInitialCartData","useRef","hasPendingUpdates","hasPendingCartUpdates","cartSyncError","handleDismissError","useCallback","setBillToShipping","value","notifyValues","isBillToShipping","hasShippingAddress","setBillingAddress","handleCheckoutData","data","isEmptyCart","isVirtualCart","billToShippingValue","useEffect","pastUpdate","getLatestCheckoutUpdate","userBillToShipping","getValue","onCheckoutInit","events","onCheckoutUpdated"],"mappings":"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"}