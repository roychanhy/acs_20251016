{"version":3,"file":"EstimateShipping.js","sources":["/@dropins/storefront-checkout/src/components/EstimateShipping/EstimateShippingSkeleton.tsx","/@dropins/storefront-checkout/src/components/EstimateShipping/EstimateShipping.tsx","/@dropins/storefront-checkout/src/containers/EstimateShipping/EstimateShipping.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Skeleton, SkeletonRow } from '@adobe-commerce/elsie/components';\nimport { FunctionComponent } from 'preact';\n\nexport const EstimateShippingSkeleton: FunctionComponent = () => {\n  return (\n    <Skeleton data-testid=\"estimate-shipping-skeleton\">\n      <SkeletonRow size=\"xsmall\" />\n    </Skeleton>\n  );\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { WithConditionals } from '@/checkout/components/ConditionalWrapper';\nimport '@/checkout/components/EstimateShipping/EstimateShipping.css';\nimport { EstimateShippingSkeleton } from '@/checkout/components/EstimateShipping/EstimateShippingSkeleton';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { VComponent, classes } from '@adobe-commerce/elsie/lib';\nimport { FunctionComponent, VNode } from 'preact';\nimport { HTMLAttributes } from 'preact/compat';\n\nexport interface EstimateShippingProps {\n  label: VNode<HTMLAttributes<HTMLSpanElement>>;\n  price: VNode<HTMLAttributes<HTMLSpanElement>>;\n  priceExclTax?: VNode<HTMLAttributes<HTMLSpanElement>>;\n  taxExcluded?: boolean;\n  taxIncluded?: boolean;\n}\n\nconst EstimateShippingComponent: FunctionComponent<EstimateShippingProps> = ({\n  label,\n  price,\n  priceExclTax,\n  taxExcluded = false,\n  taxIncluded = false,\n}) => {\n  const translations = useText({\n    withTaxes: 'Checkout.EstimateShipping.withTaxes',\n    withoutTaxes: 'Checkout.EstimateShipping.withoutTaxes',\n  });\n\n  return (\n    <div className=\"checkout-estimate-shipping\" data-testid=\"estimate-shipping\">\n      <VComponent className=\"checkout-estimate-shipping__label\" node={label} />\n      <VComponent className=\"checkout-estimate-shipping__price\" node={price} />\n\n      {taxIncluded && (\n        <span\n          className={classes(['checkout-estimate-shipping__caption'])}\n          data-testid=\"shipping-tax-included\"\n        >\n          {translations.withTaxes}\n        </span>\n      )}\n\n      {taxExcluded && (\n        <span\n          className={classes(['checkout-estimate-shipping__caption'])}\n          data-testid=\"shipping-tax-included-excluded\"\n        >\n          {priceExclTax}&nbsp;\n          {translations.withoutTaxes}\n        </span>\n      )}\n    </div>\n  );\n};\n\nexport const EstimateShipping = WithConditionals(\n  EstimateShippingComponent,\n  EstimateShippingSkeleton\n);\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { EstimateShipping as EstimateShippingComponent } from '@/checkout/components';\nimport {\n  Cart,\n  Price as PriceModel,\n  ShippingEstimate,\n  TaxDisplay,\n} from '@/checkout/data/models';\nimport { getLatestCheckoutUpdate } from '@/checkout/lib';\nimport { state } from '@/checkout/lib/state';\nimport { Price } from '@adobe-commerce/elsie/components';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { Container } from '@adobe-commerce/elsie/lib';\nimport { events } from '@adobe-commerce/event-bus';\nimport { useCallback, useEffect, useState } from 'preact/hooks';\n\ninterface ShippingData {\n  estimated?: boolean;\n  amount: PriceModel;\n  amountExclTax?: PriceModel;\n  amountInclTax?: PriceModel;\n}\n\nexport interface EstimateShippingProps {\n  active?: boolean;\n}\n\nexport const EstimateShipping: Container<EstimateShippingProps> = ({\n  active = true,\n}) => {\n  const [data, setData] = useState<ShippingData | null | undefined>();\n\n  const isFreeShipping = data?.amount.value === 0;\n  const shippingDisplay = state.config?.shoppingCartDisplaySetting.shipping;\n  const taxExcluded = shippingDisplay === TaxDisplay.INCLUDING_EXCLUDING_TAX;\n  const taxIncluded = shippingDisplay === TaxDisplay.INCLUDING_TAX;\n\n  const translations = useText({\n    freeShipping: 'Checkout.EstimateShipping.freeShipping',\n    taxToBeDetermined: 'Checkout.EstimateShipping.taxToBeDetermined',\n    label: 'Checkout.EstimateShipping.label',\n    estimated: 'Checkout.EstimateShipping.estimated',\n  });\n\n  const handleCheckoutData = useCallback((data: Cart | null) => {\n    const isEmptyCart = !data || data.isEmpty;\n    const isVirtualCart = Boolean(data?.isVirtual);\n\n    if (isEmptyCart || isVirtualCart) {\n      setData(null);\n      return;\n    }\n\n    const primaryAddress = data.shippingAddresses?.[0];\n\n    if (!primaryAddress) {\n      return;\n    }\n\n    const shippingMethod = primaryAddress?.selectedShippingMethod;\n\n    if (!shippingMethod) {\n      setData(null);\n      return;\n    }\n\n    const { amount, amountExclTax, amountInclTax } = shippingMethod;\n    setData({ estimated: false, amount, amountExclTax, amountInclTax });\n  }, []);\n\n  const handleShippingEstimate = useCallback((estimation: ShippingEstimate) => {\n    let shippingData: ShippingData | null = null;\n\n    if (estimation.shippingMethod) {\n      const shippingMethod = estimation.shippingMethod;\n\n      shippingData = {\n        estimated: true,\n        amount: shippingMethod.amount,\n        amountExclTax: shippingMethod.amountExclTax,\n        amountInclTax: shippingMethod.amountInclTax,\n      };\n    }\n\n    setData(shippingData);\n  }, []);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const onShippingEstimate = events.on(\n      'shipping/estimate',\n      handleShippingEstimate,\n      { eager: true }\n    );\n\n    return () => {\n      onShippingEstimate?.off();\n    };\n  }, [active, handleShippingEstimate]);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const pastUpdate = getLatestCheckoutUpdate();\n\n    if (pastUpdate) {\n      handleCheckoutData(pastUpdate);\n      return;\n    }\n\n    const onCheckoutInit = events.on(\n      'checkout/initialized',\n      handleCheckoutData,\n      { eager: true }\n    );\n\n    return () => {\n      onCheckoutInit?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const onCheckoutUpdated = events.on(\n      'checkout/updated',\n      handleCheckoutData,\n      { eager: false }\n    );\n\n    return () => {\n      onCheckoutUpdated?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  const renderPrice = () => {\n    if (isFreeShipping) {\n      return (\n        <span data-testid=\"free-shipping\">{translations.freeShipping}</span>\n      );\n    }\n\n    if (taxIncluded && data?.amountInclTax) {\n      return (\n        <Price\n          amount={data.amountInclTax.value}\n          currency={data.amountInclTax.currency}\n          data-testid=\"shipping\"\n        />\n      );\n    }\n\n    return (\n      <Price\n        amount={data?.amount.value}\n        currency={data?.amount.currency}\n        data-testid=\"shipping\"\n      />\n    );\n  };\n\n  const renderPriceExclTax = () => {\n    if (!data?.amountExclTax)\n      return <span>{translations.taxToBeDetermined}</span>;\n\n    return (\n      <Price\n        amount={data.amountExclTax.value}\n        currency={data.amountExclTax.currency}\n        data-testid=\"shipping-excluding-tax\"\n      />\n    );\n  };\n\n  const renderLabel = () => {\n    const label = data?.estimated ? translations.estimated : translations.label;\n    return <span data-testid=\"estimate-shipping-label\">{label}</span>;\n  };\n\n  return (\n    <EstimateShippingComponent\n      initialized={data !== undefined}\n      label={renderLabel()}\n      price={renderPrice()}\n      priceExclTax={renderPriceExclTax()}\n      taxExcluded={taxExcluded && !isFreeShipping}\n      taxIncluded={taxIncluded && !isFreeShipping}\n      visible={active && data !== null}\n    />\n  );\n};\n"],"names":["EstimateShippingSkeleton","jsx","Skeleton","SkeletonRow","EstimateShippingComponent","label","price","priceExclTax","taxExcluded","taxIncluded","translations","useText","jsxs","VComponent","classes","EstimateShipping","WithConditionals","active","data","setData","useState","isFreeShipping","shippingDisplay","_a","state","TaxDisplay","handleCheckoutData","useCallback","isEmptyCart","isVirtualCart","primaryAddress","shippingMethod","amount","amountExclTax","amountInclTax","handleShippingEstimate","estimation","shippingData","useEffect","onShippingEstimate","events","pastUpdate","getLatestCheckoutUpdate","onCheckoutInit","onCheckoutUpdated","renderPrice","Price","renderPriceExclTax"],"mappings":"izBAoBO,MAAMA,EAA8C,IAEvDC,EAACC,GAAS,cAAY,6BACpB,WAACC,EAAY,CAAA,KAAK,SAAS,CAC7B,CAAA,ECSEC,EAAsE,CAAC,CAC3E,MAAAC,EACA,MAAAC,EACA,aAAAC,EACA,YAAAC,EAAc,GACd,YAAAC,EAAc,EAChB,IAAM,CACJ,MAAMC,EAAeC,EAAQ,CAC3B,UAAW,sCACX,aAAc,wCAAA,CACf,EAED,OACGC,EAAA,MAAA,CAAI,UAAU,6BAA6B,cAAY,oBACtD,SAAA,CAAAX,EAACY,EAAW,CAAA,UAAU,oCAAoC,KAAMR,EAAO,EACtEJ,EAAAY,EAAA,CAAW,UAAU,oCAAoC,KAAMP,EAAO,EAEtEG,GACCR,EAAC,OAAA,CACC,UAAWa,EAAQ,CAAC,qCAAqC,CAAC,EAC1D,cAAY,wBAEX,SAAaJ,EAAA,SAAA,CAChB,EAGDF,GACCI,EAAC,OAAA,CACC,UAAWE,EAAQ,CAAC,qCAAqC,CAAC,EAC1D,cAAY,iCAEX,SAAA,CAAAP,EAAa,IACbG,EAAa,YAAA,CAAA,CAAA,CAChB,EAEJ,CAEJ,EAEaK,EAAmBC,EAC9BZ,EACAJ,CACF,EChCae,GAAqD,CAAC,CACjE,OAAAE,EAAS,EACX,IAAM,OACJ,KAAM,CAACC,EAAMC,CAAO,EAAIC,EAA0C,EAE5DC,GAAiBH,GAAA,YAAAA,EAAM,OAAO,SAAU,EACxCI,GAAkBC,EAAAC,EAAM,SAAN,YAAAD,EAAc,2BAA2B,SAC3Df,EAAcc,IAAoBG,EAAW,wBAC7ChB,EAAca,IAAoBG,EAAW,cAE7Cf,EAAeC,EAAQ,CAC3B,aAAc,yCACd,kBAAmB,8CACnB,MAAO,kCACP,UAAW,qCAAA,CACZ,EAEKe,EAAqBC,EAAaT,GAAsB,OACtD,MAAAU,EAAc,CAACV,GAAQA,EAAK,QAC5BW,EAAgB,GAAQX,GAAAA,MAAAA,EAAM,WAEpC,GAAIU,GAAeC,EAAe,CAChCV,EAAQ,IAAI,EACZ,MAAA,CAGI,MAAAW,GAAiBZ,EAAAA,EAAK,oBAALA,YAAAA,EAAyB,GAEhD,GAAI,CAACY,EACH,OAGF,MAAMC,EAAiBD,GAAA,YAAAA,EAAgB,uBAEvC,GAAI,CAACC,EAAgB,CACnBZ,EAAQ,IAAI,EACZ,MAAA,CAGF,KAAM,CAAE,OAAAa,EAAQ,cAAAC,EAAe,cAAAC,CAAkB,EAAAH,EACjDZ,EAAQ,CAAE,UAAW,GAAO,OAAAa,EAAQ,cAAAC,EAAe,cAAAC,EAAe,CACpE,EAAG,EAAE,EAECC,EAAyBR,EAAaS,GAAiC,CAC3E,IAAIC,EAAoC,KAExC,GAAID,EAAW,eAAgB,CAC7B,MAAML,EAAiBK,EAAW,eAEnBC,EAAA,CACb,UAAW,GACX,OAAQN,EAAe,OACvB,cAAeA,EAAe,cAC9B,cAAeA,EAAe,aAChC,CAAA,CAGFZ,EAAQkB,CAAY,CACtB,EAAG,EAAE,EAELC,EAAU,IAAM,CACd,GAAI,CAACrB,EAAQ,OAEb,MAAMsB,EAAqBC,EAAO,GAChC,oBACAL,EACA,CAAE,MAAO,EAAK,CAChB,EAEA,MAAO,IAAM,CACXI,GAAA,MAAAA,EAAoB,KACtB,CAAA,EACC,CAACtB,EAAQkB,CAAsB,CAAC,EAEnCG,EAAU,IAAM,CACd,GAAI,CAACrB,EAAQ,OAEb,MAAMwB,EAAaC,EAAwB,EAE3C,GAAID,EAAY,CACdf,EAAmBe,CAAU,EAC7B,MAAA,CAGF,MAAME,EAAiBH,EAAO,GAC5B,uBACAd,EACA,CAAE,MAAO,EAAK,CAChB,EAEA,MAAO,IAAM,CACXiB,GAAA,MAAAA,EAAgB,KAClB,CAAA,EACC,CAAC1B,EAAQS,CAAkB,CAAC,EAE/BY,EAAU,IAAM,CACd,GAAI,CAACrB,EAAQ,OAEb,MAAM2B,EAAoBJ,EAAO,GAC/B,mBACAd,EACA,CAAE,MAAO,EAAM,CACjB,EAEA,MAAO,IAAM,CACXkB,GAAA,MAAAA,EAAmB,KACrB,CAAA,EACC,CAAC3B,EAAQS,CAAkB,CAAC,EAE/B,MAAMmB,EAAc,IACdxB,EAECpB,EAAA,OAAA,CAAK,cAAY,gBAAiB,WAAa,aAAa,EAI7DQ,IAAeS,GAAA,MAAAA,EAAM,eAErBjB,EAAC6C,EAAA,CACC,OAAQ5B,EAAK,cAAc,MAC3B,SAAUA,EAAK,cAAc,SAC7B,cAAY,UAAA,CACd,EAKFjB,EAAC6C,EAAA,CACC,OAAQ5B,GAAA,YAAAA,EAAM,OAAO,MACrB,SAAUA,GAAA,YAAAA,EAAM,OAAO,SACvB,cAAY,UAAA,CACd,EAIE6B,EAAqB,IACpB7B,GAAA,MAAAA,EAAM,cAITjB,EAAC6C,EAAA,CACC,OAAQ5B,EAAK,cAAc,MAC3B,SAAUA,EAAK,cAAc,SAC7B,cAAY,wBAAA,CACd,EAPOjB,EAAC,OAAM,CAAA,SAAAS,EAAa,iBAAkB,CAAA,EAiB/C,OAAAT,EAACG,EAAA,CACC,YAAac,IAAS,OACtB,OARgB,IAAM,CACxB,MAAMb,EAAQa,GAAA,MAAAA,EAAM,UAAYR,EAAa,UAAYA,EAAa,MACtE,OAAQT,EAAA,OAAA,CAAK,cAAY,0BAA2B,SAAMI,EAAA,CAC5D,GAKuB,EACnB,MAAOwC,EAAY,EACnB,aAAcE,EAAmB,EACjC,YAAavC,GAAe,CAACa,EAC7B,YAAaZ,GAAe,CAACY,EAC7B,QAASJ,GAAUC,IAAS,IAAA,CAC9B,CAEJ"}