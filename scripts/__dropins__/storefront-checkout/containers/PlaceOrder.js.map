{"version":3,"file":"PlaceOrder.js","sources":["/@dropins/storefront-checkout/src/components/PlaceOrder/PlaceOrderSkeleton.tsx","/@dropins/storefront-checkout/src/components/PlaceOrder/PlaceOrder.tsx","/@dropins/storefront-checkout/src/containers/PlaceOrder/PlaceOrder.tsx"],"sourcesContent":["/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { Skeleton, SkeletonRow } from '@adobe-commerce/elsie/components';\nimport { FunctionComponent } from 'preact';\n\nexport const PlaceOrderSkeleton: FunctionComponent = () => {\n  return (\n    <Skeleton data-testid=\"place-order-skeleton\">\n      <SkeletonRow size=\"small\" variant=\"empty\" />\n      <SkeletonRow size=\"small\" />\n    </Skeleton>\n  );\n};\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { WithConditionals } from '@/checkout/components/ConditionalWrapper/index';\nimport '@/checkout/components/PlaceOrder/PlaceOrder.css';\nimport { PlaceOrderSkeleton } from '@/checkout/components/PlaceOrder/PlaceOrderSkeleton';\nimport { Button } from '@adobe-commerce/elsie/components';\nimport { classes } from '@adobe-commerce/elsie/lib';\nimport { FunctionComponent } from 'preact';\nimport { HTMLAttributes } from 'preact/compat';\n\nexport interface PlaceOrderProps extends HTMLAttributes<HTMLDivElement> {\n  disabled?: boolean;\n  onClick: (event: Event) => Promise<void>;\n}\n\nconst PlaceOrderComponent: FunctionComponent<PlaceOrderProps> = ({\n  children,\n  className,\n  disabled = false,\n  onClick,\n}) => {\n  return (\n    <div className={classes(['checkout-place-order', className])}>\n      <Button\n        key=\"placeOrder\"\n        className=\"checkout-place-order__button\"\n        data-testid=\"place-order-button\"\n        disabled={disabled}\n        size=\"medium\"\n        type=\"submit\"\n        variant=\"primary\"\n        onClick={onClick}\n      >\n        {children}\n      </Button>\n    </div>\n  );\n};\n\nexport const PlaceOrder = WithConditionals(\n  PlaceOrderComponent,\n  PlaceOrderSkeleton\n);\n","/********************************************************************\n * ADOBE CONFIDENTIAL\n * __________________\n *\n *  Copyright 2024 Adobe\n *  All Rights Reserved.\n *\n * NOTICE:  All information contained herein is, and remains\n * the property of Adobe and its suppliers, if any. The intellectual\n * and technical concepts contained herein are proprietary to Adobe\n * and its suppliers and are protected by all applicable intellectual\n * property laws, including trade secret and copyright laws.\n * Dissemination of this information or reproduction of this material\n * is strictly forbidden unless prior written permission is obtained\n * from Adobe.\n *******************************************************************/\n\nimport { UnexpectedError } from '@/checkout/api';\nimport { PlaceOrder as PlaceOrderComponent } from '@/checkout/components/PlaceOrder/PlaceOrder';\nimport { Cart } from '@/checkout/data/models/cart';\nimport {\n  getLatestCheckoutUpdate,\n  getValue,\n  hasPendingCartUpdates,\n  state,\n} from '@/checkout/lib';\nimport { serverErrorSignal } from '@/checkout/signals';\nimport { Item as ItemModel } from '@/checkout/types/cart';\nimport { useText } from '@adobe-commerce/elsie/i18n';\nimport { Container, Slot, SlotProps } from '@adobe-commerce/elsie/lib';\nimport { events } from '@adobe-commerce/event-bus';\nimport { HTMLAttributes } from 'preact/compat';\nimport { useCallback, useEffect, useState } from 'preact/hooks';\n\nexport interface ContentSlotContext {\n  code: string;\n}\n\nexport interface HandlePlaceOrderContext {\n  code: string;\n  cartId: string;\n}\n\nexport interface PlaceOrderProps extends HTMLAttributes<HTMLDivElement> {\n  disabled?: boolean;\n  active?: boolean;\n  handleValidation?: () => boolean;\n  handlePlaceOrder: (ctx: HandlePlaceOrderContext) => Promise<void>;\n  slots?: {\n    Content?: SlotProps<ContentSlotContext>;\n  };\n}\n\nexport const PlaceOrder: Container<PlaceOrderProps> = ({\n  disabled: disabledViaProp = false,\n  active = true,\n  handleValidation,\n  handlePlaceOrder,\n  slots,\n  ...props\n}) => {\n  const [isInitialized, setIsInitialized] = useState(false);\n  const [hasOutOfStockItems, setHasOutOfStockItems] = useState(false);\n\n  const hasPendingUpdates = hasPendingCartUpdates.value;\n\n  const translations = useText({\n    CheckoutUnexpectedError: 'Checkout.ServerError.unexpected',\n    placeOrderButton: 'Checkout.PlaceOrder.button',\n  });\n\n  const handlePlaceOrderError = useCallback(\n    (error: any) => {\n      serverErrorSignal.value =\n        error instanceof TypeError || error instanceof UnexpectedError\n          ? translations.CheckoutUnexpectedError\n          : error.message;\n    },\n    [translations]\n  );\n\n  const handleClick = useCallback(async () => {\n    try {\n      if (handleValidation && !handleValidation()) return;\n\n      await handlePlaceOrder({\n        cartId: state.cartId!,\n        code: getValue('selectedPaymentMethod')?.code ?? '',\n      });\n    } catch (error: any) {\n      handlePlaceOrderError(error);\n    }\n  }, [handleValidation, handlePlaceOrder, handlePlaceOrderError]);\n\n  const handleCheckoutData = useCallback((data: Cart | null) => {\n    const isEmptyCart = !data || data.isEmpty;\n\n    if (isEmptyCart) {\n      setHasOutOfStockItems(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    if (active === false) return;\n\n    const onCartData = events.on(\n      'cart/initialized',\n      (data) => {\n        const items = (data?.items || []) as ItemModel[];\n        setHasOutOfStockItems(\n          items.some((item) => item.outOfStock || item.insufficientQuantity)\n        );\n      },\n      { eager: true }\n    );\n\n    return () => {\n      onCartData?.off();\n    };\n  }, [active]);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const pastUpdate = getLatestCheckoutUpdate();\n\n    if (pastUpdate) {\n      setIsInitialized(true);\n      handleCheckoutData(pastUpdate);\n      return;\n    }\n\n    const onCheckoutInit = events.on(\n      'checkout/initialized',\n      (data) => {\n        setIsInitialized(true);\n        handleCheckoutData(data);\n      },\n      { eager: true }\n    );\n\n    return () => {\n      onCheckoutInit?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  useEffect(() => {\n    if (!active) return;\n\n    const onCheckoutUpdated = events.on(\n      'checkout/updated',\n      (data) => {\n        handleCheckoutData(data);\n      },\n      { eager: false }\n    );\n\n    return () => {\n      onCheckoutUpdated?.off();\n    };\n  }, [active, handleCheckoutData]);\n\n  return (\n    <PlaceOrderComponent\n      {...props}\n      disabled={disabledViaProp || hasOutOfStockItems || hasPendingUpdates}\n      initialized={isInitialized}\n      visible={active}\n      onClick={handleClick}\n    >\n      <Slot\n        context={{ code: getValue('selectedPaymentMethod')?.code ?? '' }}\n        name=\"Content\"\n        slot={slots?.Content}\n      >\n        {translations.placeOrderButton}\n      </Slot>\n    </PlaceOrderComponent>\n  );\n};\n"],"names":["PlaceOrderSkeleton","jsxs","Skeleton","jsx","SkeletonRow","PlaceOrderComponent","children","className","disabled","onClick","classes","Button","PlaceOrder","WithConditionals","disabledViaProp","active","handleValidation","handlePlaceOrder","slots","props","isInitialized","setIsInitialized","useState","hasOutOfStockItems","setHasOutOfStockItems","hasPendingUpdates","hasPendingCartUpdates","translations","useText","handlePlaceOrderError","useCallback","error","serverErrorSignal","UnexpectedError","handleClick","state","_a","getValue","handleCheckoutData","data","useEffect","onCartData","events","items","item","pastUpdate","getLatestCheckoutUpdate","onCheckoutInit","onCheckoutUpdated","Slot"],"mappings":"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"}